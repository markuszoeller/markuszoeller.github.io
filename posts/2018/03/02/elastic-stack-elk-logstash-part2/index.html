<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Elastic Stack (formerly ELK) - Logstash (Part 2) &#8212; Markus Zoeller Blog</title>
    
    <link rel="stylesheet" href="../../../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/css/asciinema-player.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/asciinema-player.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../../about/" />
    <link rel="index" title="Index" href="../../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../../search/" />
  
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  
  <link rel="alternate" type="application/atom+xml"  href="../../../../../posts/atom.xml" title="Markus's Brain Swap Space">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../../">
          MZIO</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../../../about/">About</a></li>
                <li><a href="../../../../category/">Categories</a></li>
                <li><a href="../../../../tag/">Tags</a></li>
                <li><a href="../../../../archive/">Archive</a></li>
                <li><a href="/posts/atom.xml"><i class='fa fa-rss-square' aria-hidden='true'></i></a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../../">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../../search/" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="elastic-stack-formerly-elk-logstash-part-2">
<h1>Elastic Stack (formerly ELK) - <em>Logstash</em> (Part 2)<a class="headerlink" href="#elastic-stack-formerly-elk-logstash-part-2" title="Permalink to this headline"> </a></h1>
<p>This is a follow-up to the previous post
<a class="reference internal" href="../../../02/16/elastic-stack-elk-logstash-part1/#elastic-stack-elk-logstash-part1"><span class="std std-ref">Elastic Stack (formerly ELK) - Logstash (Part 1)</span></a>.
We continue were we left of the last time, and dive right into it.
No intro, no explanation of concepts or terms, only configuration of
<em>Logstash</em> pipelines.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#output-our-example-log-to-es" id="id8">Output our example log to <em>Elasticsearch</em></a></li>
<li><a class="reference internal" href="#a-more-realistic-logging-data" id="id9">A more realistic logging data</a></li>
<li><a class="reference internal" href="#parse-logging-data-by-delimiter" id="id10">Parse logging data by delimiter</a></li>
<li><a class="reference internal" href="#remove-fields" id="id11">Remove fields</a></li>
<li><a class="reference internal" href="#set-the-timestamp-field" id="id12">Set the timestamp field</a></li>
<li><a class="reference internal" href="#specify-data-type-conversion" id="id13">Specify data type conversion</a></li>
<li><a class="reference internal" href="#store-syslog-too" id="id14">Store syslog too</a></li>
<li><a class="reference internal" href="#summary" id="id15">Summary</a></li>
<li><a class="reference internal" href="#references" id="id16">References</a></li>
</ul>
</div>
<table border="1" class="docutils" id="id7">
<caption><span class="caption-text">Change history:</span><a class="headerlink" href="#id7" title="Permalink to this table"> </a></caption>
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Date</th>
<th class="head">Change description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>2018-03-02</td>
<td>The first release</td>
</tr>
</tbody>
</table>
<p>To get most out of this post, it&#8217;s advisable to read the two previous posts
in this series:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="../../../01/05/elastic-stack-elk-elasticsearch/#elastic-stack-elk-elasticsearch"><span class="std std-ref">Elastic Stack (formerly ELK) - Elasticsearch</span></a></li>
<li><a class="reference internal" href="../../../02/16/elastic-stack-elk-logstash-part1/#elastic-stack-elk-logstash-part1"><span class="std std-ref">Elastic Stack (formerly ELK) - Logstash (Part 1)</span></a></li>
</ol>
<p>If you already know that content, here we go.</p>
<div class="section" id="output-our-example-log-to-es">
<h2><a class="toc-backref" href="#contents">Output our example log to <em>Elasticsearch</em></a><a class="headerlink" href="#output-our-example-log-to-es" title="Permalink to this headline"> </a></h2>
<p>Create a new pipeline configuration file named
<code class="docutils literal"><span class="pre">/etc/logstash/conf.d/elasticsearch.conf</span></code> and add the content below:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span>input {
  file {
    id =&gt; &quot;my-app2-id-in&quot;
    path =&gt; &quot;/var/log/app2/source.log&quot;
  }
}

output {
  elasticsearch {
    id =&gt; &quot;my-app2-id-out&quot;
    hosts =&gt; [&quot;http://es1:9200&quot;]
    index =&gt; &quot;app2&quot;
  }
}
</pre></div>
</td></tr></table></div>
<p>Add some log entries to our log file:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="k">$(</span>date -Is<span class="k">)</span> &gt;&gt; /var/log/app2/source.log
</pre></div>
</td></tr></table></div>
<p>Query <em>Elasticsearch</em> if the new index got created:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ curl es1:9200/_cat/indices?format<span class="o">=</span>yaml
</pre></div>
</td></tr></table></div>
<p>The response we get:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">health</span><span class="p p-Indicator">:</span> <span class="s">&quot;yellow&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">status</span><span class="p p-Indicator">:</span> <span class="s">&quot;open&quot;</span>
<span class="hll">  <span class="l l-Scalar l-Scalar-Plain">index</span><span class="p p-Indicator">:</span> <span class="s">&quot;app2&quot;</span>
</span>  <span class="l l-Scalar l-Scalar-Plain">uuid</span><span class="p p-Indicator">:</span> <span class="s">&quot;hL-CbpmmTm2I_aKryzqj-A&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">pri</span><span class="p p-Indicator">:</span> <span class="s">&quot;5&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">rep</span><span class="p p-Indicator">:</span> <span class="s">&quot;1&quot;</span>
<span class="hll">  <span class="l l-Scalar l-Scalar-Plain">docs.count</span><span class="p p-Indicator">:</span> <span class="s">&quot;2&quot;</span>
</span>  <span class="l l-Scalar l-Scalar-Plain">docs.deleted</span><span class="p p-Indicator">:</span> <span class="s">&quot;0&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">store.size</span><span class="p p-Indicator">:</span> <span class="s">&quot;11kb&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">pri.store.size</span><span class="p p-Indicator">:</span> <span class="s">&quot;11kb&quot;</span>
</pre></div>
</td></tr></table></div>
<p>Query <em>Elasticsearch</em> for the documents for the index <code class="docutils literal"><span class="pre">app2</span></code>:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ curl -s es1:9200/app2/_search? <span class="p">|</span> jq
</pre></div>
</td></tr></table></div>
<p>The response we get:</p>
<div class="highlight-json"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;took&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;timed_out&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&quot;_shards&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nt">&quot;successful&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nt">&quot;skipped&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&quot;max_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
<span class="hll">        <span class="nt">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;app2&quot;</span><span class="p">,</span>
</span>        <span class="nt">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;YhO3r2EBDLUsSt4lTcKT&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="hll">          <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/log/app2/source.log&quot;</span><span class="p">,</span>
</span><span class="hll">          <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;ls1&quot;</span><span class="p">,</span>
</span><span class="hll">          <span class="nt">&quot;@version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class="hll">          <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-19T20:18:00.592Z&quot;</span><span class="p">,</span>
</span><span class="hll">          <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-19T20:18:00+00:00&quot;</span>
</span>        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;app2&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;YRO2r2EBDLUsSt4l88J0&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-19T20:17:36+00:00&quot;</span><span class="p">,</span>
          <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/log/app2/source.log&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-19T20:17:37.420Z&quot;</span><span class="p">,</span>
          <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;ls1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><em>Logstash</em> did its job to encapsulate our messages into new JSON objects with
meta data and to forward this JSON object to <em>Elasticsearch</em>. To be precise,
the <code class="docutils literal"><span class="pre">elasticsearch</span></code> output plugin did the job. The index also got
created like specified in the config file.</p>
<p>So far, we&#8217;ve used fairly useless data for the log entries. The next
section will use more realistic one.</p>
</div>
<div class="section" id="a-more-realistic-logging-data">
<h2><a class="toc-backref" href="#contents">A more realistic logging data</a><a class="headerlink" href="#a-more-realistic-logging-data" title="Permalink to this headline"> </a></h2>
<p>Writing the current timestamp into a file was just a vehicle to
have unique log entries, which makes it easier to follow.
Let&#8217;s create more realistic logging data. This will show us a nice
problem we will solve in the sections after this one.</p>
<p>Create a <em>Python</em> script <code class="docutils literal"><span class="pre">example.py</span></code> on server <code class="docutils literal"><span class="pre">ls1</span></code> which logs
into a file:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)s</span><span class="s1"> | &#39;</span>
                           <span class="s1">&#39;</span><span class="si">%(process)d</span><span class="s1"> | </span><span class="si">%(thread)d</span><span class="s1"> | &#39;</span>
                           <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1"> | </span><span class="si">%(funcName)s</span><span class="s1"> | </span><span class="si">%(lineno)s</span><span class="s1"> | &#39;</span>
                           <span class="s1">&#39;</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
<span class="hll">                    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;/var/log/app3/source.log&quot;</span><span class="p">)</span>
</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;example&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">do_something</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;I did something!&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Started the application.&#39;</span><span class="p">)</span>
    <span class="n">do_something</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>The highlighted line is the important one. This line ensures that our
log record data <a class="footnote-reference" href="#pylogrecord" id="id1">[1]</a> will be stored in a file, which will
be the the data source for <em>Logstash</em>.</p>
<p>Create a new pipeline file in <code class="docutils literal"><span class="pre">/etc/logstash/conf.d/es-app3.conf</span></code>:</p>
<div class="highlight-json"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span>input {
  file {
    id =&gt; &quot;my-app3-id-in&quot;
<span class="hll">    path =&gt; &quot;/var/log/app3/source.log&quot;
</span>  }
}

output {
  elasticsearch {
    id =&gt; &quot;my-app3-id-out&quot;
    hosts =&gt; [&quot;http://es1:9200&quot;]
    index =&gt; &quot;app3&quot;
  }
}
</pre></div>
</td></tr></table></div>
<p>Execute the example app:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ vagrant ssh ls1
$ <span class="nb">cd</span> /opt/app3
$ chmod +x example.py
$ ./example.py
</pre></div>
</td></tr></table></div>
<p>This creates these entries in <code class="docutils literal"><span class="pre">/var/log/app3/source.log</span></code>:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span>2018-02-20 20:40:25,121 | INFO | 2654 | 140522357225216 | example | main | 18 | Started the application.
2018-02-20 20:40:25,121 | DEBUG | 2654 | 140522357225216 | example | do_something | 14 | I did something!
</pre></div>
</td></tr></table></div>
<p>Query <em>Elasticsearch</em> for the documents for the index <code class="docutils literal"><span class="pre">app3</span></code>:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ curl -s es1:9200/app3/_search? <span class="p">|</span> jq
</pre></div>
</td></tr></table></div>
<p>The response we get looks like below. I trimmed it down by using <code class="docutils literal"><span class="pre">[...]</span></code>
where I removed portions:</p>
<div class="highlight-json"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span>{
  [...],
  &quot;hits&quot;: {
    &quot;total&quot;: 2,
    &quot;max_score&quot;: 1,
    &quot;hits&quot;: [
      {
        [...],
        &quot;_source&quot;: {
          &quot;@version&quot;: &quot;1&quot;,
<span class="hll">          &quot;message&quot;: &quot;2018-02-20 20:40:25,121 | DEBUG | 2654 | 140522357225216 | example | do_something | 14 | I did something!&quot;,
</span>          &quot;@timestamp&quot;: &quot;2018-02-20T20:40:36.961Z&quot;,
          &quot;path&quot;: &quot;/var/log/app3/source.log&quot;,
          &quot;host&quot;: &quot;ls1&quot;
        }
      },
      {
        [...],
        &quot;_source&quot;: {
          &quot;@version&quot;: &quot;1&quot;,
<span class="hll">          &quot;message&quot;: &quot;2018-02-20 20:40:25,121 | INFO | 2654 | 140522357225216 | example | main | 18 | Started the application.&quot;,
</span>          &quot;@timestamp&quot;: &quot;2018-02-20T20:40:36.960Z&quot;,
          &quot;path&quot;: &quot;/var/log/app3/source.log&quot;,
          &quot;host&quot;: &quot;ls1&quot;
        }
      },
    ]
  }
}
</pre></div>
</td></tr></table></div>
<p>Given the knowledge from before, this is the expected outcome.</p>
<p>Assumed we have thousands of log entries like this for a big application
with tons of functions and classes and modules and log levels and threads:
How do we reasonably <strong>query only the log messages</strong> we care about in
a specific scenario?</p>
<p>We could use the built-in query DSL of <em>Elasticsearch</em> <a class="footnote-reference" href="#esquery" id="id2">[2]</a> to do searches on the
<code class="docutils literal"><span class="pre">message</span></code> value only. This would feel like a <code class="docutils literal"><span class="pre">grep</span></code> and will probably
bring good results at first:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ curl -s <span class="s1">&#39;es1:9200/app3/_search&#39;</span> -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -d<span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;query&quot;: {</span>
<span class="s1">        &quot;match&quot; : {</span>
<span class="hll"><span class="s1">            &quot;message&quot; : &quot;DEBUG&quot;</span>
</span><span class="s1">        }</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">&#39;</span> <span class="p">|</span> jq
</pre></div>
</td></tr></table></div>
<p>The response we get:</p>
<div class="highlight-json"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span>{
  [...]
  &quot;hits&quot;: {
    &quot;total&quot;: 1,
    &quot;max_score&quot;: 0.2876821,
    &quot;hits&quot;: [
      {
        [...]
        &quot;_source&quot;: {
          &quot;@version&quot;: &quot;1&quot;,
<span class="hll">          &quot;message&quot;: &quot;2018-02-20 20:40:25,121 | DEBUG | 2654 | 140522357225216 | example | do_something | 14 | I did something!&quot;,
</span>          &quot;@timestamp&quot;: &quot;2018-02-20T20:40:36.961Z&quot;,
          &quot;path&quot;: &quot;/var/log/app3/source.log&quot;,
          &quot;host&quot;: &quot;ls1&quot;
        }
      }
    ]
  }
}
</pre></div>
</td></tr></table></div>
<p>The query we provided to <em>Elasticsearch</em> matched one of our logging entries.</p>
<p>This is already pretty cool, but maybe we can split the very long
logging message into something more meaningful, which can then
be queried more easily.</p>
</div>
<div class="section" id="parse-logging-data-by-delimiter">
<h2><a class="toc-backref" href="#contents">Parse logging data by delimiter</a><a class="headerlink" href="#parse-logging-data-by-delimiter" title="Permalink to this headline"> </a></h2>
<p>The <code class="docutils literal"><span class="pre">dissect</span></code> filter plugin <a class="footnote-reference" href="#lsdissect" id="id3">[3]</a> allows to transform your
log entries based on delimiters. It&#8217;s a good fit for the classical log files
like the one from before.</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span>input {
  file {
    id =&gt; &quot;my-app4-id-in&quot;
    path =&gt; &quot;/var/log/app3/source.log&quot;
  }
}

filter {
  dissect {
    mapping =&gt; {
      &quot;message&quot; =&gt; &quot;%{time} | %{level} | %{pid} | %{thread} | %{loggername} | %{function} | %{line} | %{msg}&quot;
    }
  }
}

output {
  elasticsearch {
    id =&gt; &quot;my-app4-id-out&quot;
    hosts =&gt; [&quot;http://es1:9200&quot;]
    index =&gt; &quot;app4&quot;
  }
}
</pre></div>
</td></tr></table></div>
<p>Execute the example application again:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ ./example.py
</pre></div>
</td></tr></table></div>
<p>Query <em>Elasticsearch</em> with the new index <code class="docutils literal"><span class="pre">app4</span></code>:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ curl -s es1:9200/app4/_search? <span class="p">|</span> jq
</pre></div>
</td></tr></table></div>
<p>Get the JSON response:</p>
<div class="highlight-json"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
  <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&quot;max_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;app4&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;R2jVzWEBRYCDJjrEtlgN&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25 16:39:49,923 | DEBUG | 4845 | 140289154119424 | example | do_something | 14 | I did something!&quot;</span><span class="p">,</span>
          <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;ls1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25 16:39:49,923&quot;</span><span class="p">,</span>
          <span class="nt">&quot;loggername&quot;</span><span class="p">:</span> <span class="s2">&quot;example&quot;</span><span class="p">,</span>
          <span class="nt">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;do_something&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25T16:39:50.125Z&quot;</span><span class="p">,</span>
          <span class="nt">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;I did something!&quot;</span><span class="p">,</span>
          <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/log/app3/source.log&quot;</span><span class="p">,</span>
          <span class="nt">&quot;line&quot;</span><span class="p">:</span> <span class="s2">&quot;14&quot;</span><span class="p">,</span>
          <span class="nt">&quot;thread&quot;</span><span class="p">:</span> <span class="s2">&quot;140289154119424&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
          <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="s2">&quot;4845&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;app4&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;RmjVzWEBRYCDJjrEtlgN&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25 16:39:49,922 | INFO | 4845 | 140289154119424 | example | main | 18 | Started the application.&quot;</span><span class="p">,</span>
          <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;ls1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25 16:39:49,922&quot;</span><span class="p">,</span>
          <span class="nt">&quot;loggername&quot;</span><span class="p">:</span> <span class="s2">&quot;example&quot;</span><span class="p">,</span>
          <span class="nt">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25T16:39:50.120Z&quot;</span><span class="p">,</span>
          <span class="nt">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Started the application.&quot;</span><span class="p">,</span>
          <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/log/app3/source.log&quot;</span><span class="p">,</span>
          <span class="nt">&quot;line&quot;</span><span class="p">:</span> <span class="s2">&quot;18&quot;</span><span class="p">,</span>
          <span class="nt">&quot;thread&quot;</span><span class="p">:</span> <span class="s2">&quot;140289154119424&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
          <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="s2">&quot;4845&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This shows that our log entries in the log file got properly split up
into fields. We should now be able to query <em>Elasticsearch</em> for those fields:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ curl -s <span class="s1">&#39;es1:9200/app4/_search&#39;</span> -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -d<span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;query&quot;: {</span>
<span class="s1">        &quot;match&quot; : {</span>
<span class="hll"><span class="s1">            &quot;level&quot; : &quot;DEBUG&quot;</span>
</span><span class="s1">        }</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">&#39;</span> <span class="p">|</span> jq
</pre></div>
</td></tr></table></div>
<p>The response we get:</p>
<div class="highlight-json"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
  <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;max_score&quot;</span><span class="p">:</span> <span class="mf">0.2876821</span><span class="p">,</span>
    <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;app4&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;R2jVzWEBRYCDJjrEtlgN&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_score&quot;</span><span class="p">:</span> <span class="mf">0.2876821</span><span class="p">,</span>
        <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25 16:39:49,923 | DEBUG | 4845 | 140289154119424 | example | do_something | 14 | I did something!&quot;</span><span class="p">,</span>
          <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;ls1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25 16:39:49,923&quot;</span><span class="p">,</span>
          <span class="nt">&quot;loggername&quot;</span><span class="p">:</span> <span class="s2">&quot;example&quot;</span><span class="p">,</span>
          <span class="nt">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;do_something&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25T16:39:50.125Z&quot;</span><span class="p">,</span>
          <span class="nt">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;I did something!&quot;</span><span class="p">,</span>
          <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/log/app3/source.log&quot;</span><span class="p">,</span>
          <span class="nt">&quot;line&quot;</span><span class="p">:</span> <span class="s2">&quot;14&quot;</span><span class="p">,</span>
          <span class="nt">&quot;thread&quot;</span><span class="p">:</span> <span class="s2">&quot;140289154119424&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
          <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="s2">&quot;4845&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">In case your <em>Elasticsearch</em> index got messy during the experiments,
you can delete it with <code class="docutils literal"><span class="pre">curl</span> <span class="pre">-X</span> <span class="pre">DELETE</span> <span class="pre">es1:9200/app4/</span></code>.</p>
</div>
<p>Three things aren&#8217;t pretty yet:</p>
<ul class="simple">
<li>The <code class="docutils literal"><span class="pre">message</span></code> field is not necessary anymore, as we have all the
information in the other fields.</li>
<li>The <code class="docutils literal"><span class="pre">&#64;timestamp</span></code> field doesn&#8217;t match our actual timestamp, captured
in field <code class="docutils literal"><span class="pre">time</span></code>.</li>
<li>The fields which hold numbers as values, like <code class="docutils literal"><span class="pre">line</span></code>, <code class="docutils literal"><span class="pre">pid</span></code> and
<code class="docutils literal"><span class="pre">thread</span></code> treat those values as strings.</li>
</ul>
<p>The next sections will show ways to do that.</p>
</div>
<div class="section" id="remove-fields">
<h2><a class="toc-backref" href="#contents">Remove fields</a><a class="headerlink" href="#remove-fields" title="Permalink to this headline"> </a></h2>
<p>The <code class="docutils literal"><span class="pre">message</span></code> field from above contains the full log entry, but
we don&#8217;t need that anymore, as we have split that into its fields.
One way to remove that extraneous field, is the <code class="docutils literal"><span class="pre">remove_field</span></code> filter
option:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span>input {
  file {
    id =&gt; &quot;my-app5-id-in&quot;
    path =&gt; &quot;/var/log/app3/source.log&quot;
  }
}

filter {
  dissect {
    mapping =&gt; {
      &quot;message&quot; =&gt; &quot;%{time} | %{level} | %{pid} | %{thread} | %{loggername} | %{function} | %{line} | %{msg}&quot;
    }
<span class="hll">    remove_field =&gt; [ &quot;message&quot; ]
</span>  }
}

output {
  elasticsearch {
    id =&gt; &quot;my-app5-id-out&quot;
    hosts =&gt; [&quot;http://es1:9200&quot;]
    index =&gt; &quot;app5&quot;
  }
}
</pre></div>
</td></tr></table></div>
<p>The response looks now like this:</p>
<div class="highlight-json"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
  <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;max_score&quot;</span><span class="p">:</span> <span class="mf">0.2876821</span><span class="p">,</span>
    <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;ls1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25 16:39:49,923&quot;</span><span class="p">,</span>
          <span class="nt">&quot;loggername&quot;</span><span class="p">:</span> <span class="s2">&quot;example&quot;</span><span class="p">,</span>
          <span class="nt">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;do_something&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25T16:39:50.125Z&quot;</span><span class="p">,</span>
          <span class="nt">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;I did something!&quot;</span><span class="p">,</span>
          <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/log/app3/source.log&quot;</span><span class="p">,</span>
          <span class="nt">&quot;line&quot;</span><span class="p">:</span> <span class="s2">&quot;14&quot;</span><span class="p">,</span>
          <span class="nt">&quot;thread&quot;</span><span class="p">:</span> <span class="s2">&quot;140289154119424&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
          <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="s2">&quot;4845&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>It looks much cleaner now. A few more things until we&#8217;re happy.</p>
</div>
<div class="section" id="set-the-timestamp-field">
<h2><a class="toc-backref" href="#contents">Set the timestamp field</a><a class="headerlink" href="#set-the-timestamp-field" title="Permalink to this headline"> </a></h2>
<p>The <code class="docutils literal"><span class="pre">date</span></code> filter plugin <a class="footnote-reference" href="#lsdate" id="id4">[5]</a> is capable of using our <code class="docutils literal"><span class="pre">time</span></code> field
and use it as input for the <code class="docutils literal"><span class="pre">&#64;timestamp</span></code> field:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span>input {
  file {
    id =&gt; &quot;my-app6-id-in&quot;
    path =&gt; &quot;/var/log/app3/source.log&quot;
  }
}

filter {
  dissect {
    mapping =&gt; {
      &quot;message&quot; =&gt; &quot;%{time} | %{level} | %{pid} | %{thread} | %{loggername} | %{function} | %{line} | %{msg}&quot;
    }
    remove_field =&gt; [ &quot;message&quot; ]
  }
<span class="hll">  date {
</span><span class="hll">    match =&gt; [ &quot;time&quot;, &quot;ISO8601&quot; ]
</span><span class="hll">    remove_field =&gt; [ &quot;time&quot; ]
</span><span class="hll">  }
</span>}

output {
  elasticsearch {
    id =&gt; &quot;my-app6-id-out&quot;
    hosts =&gt; [&quot;http://es1:9200&quot;]
    index =&gt; &quot;app6&quot;
  }
}
</pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal"><span class="pre">time</span></code> field served its purpose, so we remove it like shown in the
previous section. This example also shows nicely, that multiple filters
can be specified in one config, and that they get executed in the
given order.</p>
<p>If your log files don&#8217;t use ISO8601, you can filter for other formats,
like the <em>Unix</em> time in seconds or milliseconds since epoch. Any other
format is also valid, e.g. <code class="docutils literal"><span class="pre">&quot;MMM</span> <span class="pre">dd</span> <span class="pre">yyyy</span> <span class="pre">HH:mm:ss&quot;</span></code>. See the docs
at <a class="footnote-reference" href="#lsdate" id="id5">[5]</a> for more details.</p>
<p>We execute our example application like before and get this response:</p>
<div class="highlight-json"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
  <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&quot;max_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;app6&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;hWgmzmEBRYCDJjrEYlhQ&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;line&quot;</span><span class="p">:</span> <span class="s2">&quot;18&quot;</span><span class="p">,</span>
          <span class="nt">&quot;loggername&quot;</span><span class="p">:</span> <span class="s2">&quot;example&quot;</span><span class="p">,</span>
          <span class="nt">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Started the application.&quot;</span><span class="p">,</span>
          <span class="nt">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span>
          <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/log/app3/source.log&quot;</span><span class="p">,</span>
          <span class="nt">&quot;thread&quot;</span><span class="p">:</span> <span class="s2">&quot;140044078098176&quot;</span><span class="p">,</span>
<span class="hll">          <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25T18:07:57.051Z&quot;</span><span class="p">,</span>
</span>          <span class="nt">&quot;@version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
          <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="s2">&quot;5923&quot;</span><span class="p">,</span>
          <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;ls1&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal"><span class="pre">time</span></code> field is gone and the <code class="docutils literal"><span class="pre">&#64;timestamp</span></code> field uses the date and
time specified in the original log file.</p>
</div>
<div class="section" id="specify-data-type-conversion">
<h2><a class="toc-backref" href="#contents">Specify data type conversion</a><a class="headerlink" href="#specify-data-type-conversion" title="Permalink to this headline"> </a></h2>
<p>The <code class="docutils literal"><span class="pre">dissect</span></code> filter provides the option <code class="docutils literal"><span class="pre">convert_datatype</span></code>
which can do a conversion to integer of float numbers. We only need
conversions to <code class="docutils literal"><span class="pre">int</span></code> here:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span>input {
  file {
    id =&gt; &quot;my-app7-id-in&quot;
    path =&gt; &quot;/var/log/app3/source.log&quot;
  }
}

filter {
  dissect {
    mapping =&gt; {
      &quot;message&quot; =&gt; &quot;%{time} | %{level} | %{pid} | %{thread} | %{loggername} | %{function} | %{line} | %{msg}&quot;
    }
    remove_field =&gt; [ &quot;message&quot; ]
<span class="hll">    convert_datatype =&gt; {
</span><span class="hll">      line =&gt; &quot;int&quot;
</span><span class="hll">      pid =&gt; &quot;int&quot;
</span><span class="hll">      thread =&gt; &quot;int&quot;
</span><span class="hll">    }
</span>  }
  date {
    match =&gt; [ &quot;time&quot;, &quot;ISO8601&quot; ]
    remove_field =&gt; [ &quot;time&quot; ]
  }
}

output {
  elasticsearch {
    id =&gt; &quot;my-app7-id-out&quot;
    hosts =&gt; [&quot;http://es1:9200&quot;]
    index =&gt; &quot;app7&quot;
  }
}
</pre></div>
</td></tr></table></div>
<p>The JSON request contains numbers now:</p>
<div class="highlight-json"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
  <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&quot;max_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;app7&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;hmg7zmEBRYCDJjrEIFgb&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/log/app3/source.log&quot;</span><span class="p">,</span>
<span class="hll">          <span class="nt">&quot;line&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
</span>          <span class="nt">&quot;@version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25T18:30:31.645Z&quot;</span><span class="p">,</span>
          <span class="nt">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
          <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;ls1&quot;</span><span class="p">,</span>
<span class="hll">          <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="mi">6195</span><span class="p">,</span>
</span>          <span class="nt">&quot;loggername&quot;</span><span class="p">:</span> <span class="s2">&quot;example&quot;</span><span class="p">,</span>
          <span class="nt">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Started the application.&quot;</span><span class="p">,</span>
          <span class="nt">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span>
<span class="hll">          <span class="nt">&quot;thread&quot;</span><span class="p">:</span> <span class="mi">140172021761792</span>
</span>        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This can be useful when you search for a
<strong>range of numeric values</strong> <a class="footnote-reference" href="#esrange" id="id6">[6]</a>:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ curl -s <span class="s1">&#39;es1:9200/app7/_search&#39;</span> -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -d<span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;query&quot;: {</span>
<span class="s1">        &quot;range&quot; : {</span>
<span class="hll"><span class="s1">            &quot;line&quot; : {</span>
</span><span class="hll"><span class="s1">                &quot;gte&quot; : 10,</span>
</span><span class="hll"><span class="s1">                &quot;lte&quot; : 15</span>
</span><span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">&#39;</span> <span class="p">|</span> jq
</pre></div>
</td></tr></table></div>
<p>The response:</p>
<div class="highlight-json"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
  <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;max_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;app7&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;h2g7zmEBRYCDJjrEIFg4&quot;</span><span class="p">,</span>
        <span class="nt">&quot;_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/log/app3/source.log&quot;</span><span class="p">,</span>
<span class="hll">          <span class="nt">&quot;line&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
</span>          <span class="nt">&quot;@version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-02-25T18:30:31.645Z&quot;</span><span class="p">,</span>
          <span class="nt">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
          <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;ls1&quot;</span><span class="p">,</span>
          <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="mi">6195</span><span class="p">,</span>
          <span class="nt">&quot;loggername&quot;</span><span class="p">:</span> <span class="s2">&quot;example&quot;</span><span class="p">,</span>
          <span class="nt">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;I did something!&quot;</span><span class="p">,</span>
          <span class="nt">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;do_something&quot;</span><span class="p">,</span>
          <span class="nt">&quot;thread&quot;</span><span class="p">:</span> <span class="mi">140172021761792</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This example isn&#8217;t that impressive, admittedly, but I&#8217;m sure you get
the idea <code class="docutils literal"><span class="pre">:-)</span></code>.</p>
</div>
<div class="section" id="store-syslog-too">
<h2><a class="toc-backref" href="#contents">Store syslog too</a><a class="headerlink" href="#store-syslog-too" title="Permalink to this headline"> </a></h2>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">syslog pattern</p>
</div>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#contents">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline"> </a></h2>
<p>Do I need to install a <em>Logstash</em> server on every application server to gather
my logs?
Nope, <em>Filebeat</em> to the rescue. That&#8217;s an insight I got while writing
this post. So I&#8217;ll take a quick look at <em>Filebeat</em> next, before finishing
this series with <em>Kibana</em>.</p>
<p>A more powerful filter plugin is <code class="docutils literal"><span class="pre">grok</span></code>.</p>
<p>This is a contract now, how about a log file which evolves? Maybe use
JSON newline delimited logs?</p>
</div>
<div class="section" id="references">
<h2><a class="toc-backref" href="#contents">References</a><a class="headerlink" href="#references" title="Permalink to this headline"> </a></h2>
<table class="docutils footnote" frame="void" id="pylogrecord" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://docs.python.org/2/library/logging.html#logrecord-attributes">https://docs.python.org/2/library/logging.html#logrecord-attributes</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="esquery" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.2/query-dsl.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.2/query-dsl.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="lsdissect" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://www.elastic.co/guide/en/logstash/6.2/plugins-filters-dissect.html">https://www.elastic.co/guide/en/logstash/6.2/plugins-filters-dissect.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="esdelidx" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.2/indices-delete-index.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.2/indices-delete-index.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="lsdate" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[5]</td><td><em>(<a class="fn-backref" href="#id4">1</a>, <a class="fn-backref" href="#id5">2</a>)</em> <a class="reference external" href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-date.html">https://www.elastic.co/guide/en/logstash/current/plugins-filters-date.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="esrange" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html</a></td></tr>
</tbody>
</table>
</div>
</div>

  <div class="section">
  
    


  
  
  </div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015-2018, Markus Zoeller.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>