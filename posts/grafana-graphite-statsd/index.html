<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Setup Grafana + Graphite + statsd &mdash; Blog  documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../../about/" />
    <link rel="top" title="Blog  documentation" href="../../" />
  
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  
  <link rel="alternate" type="application/atom+xml"  href="../../posts/atom.xml" title="Markus's Brain Swap Space">
  
  
  <link href="True" rel="stylesheet">
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="setup-grafana-graphite-statsd">
<h1>Setup Grafana + Graphite + statsd<a class="headerlink" href="#setup-grafana-graphite-statsd" title="Permalink to this headline">¶</a></h1>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">add a useful abstract</p>
</div>
<ul class="simple">
<li>no details about statsd, graphite or grafana</li>
<li>get things running fast without fakes and mocks</li>
<li>be &#8220;build my dashboard&#8221; ready in 15 minutes</li>
</ul>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#environment" id="id7">Environment</a></li>
<li><a class="reference internal" href="#step-by-step" id="id8">Step-by-Step</a></li>
<li><a class="reference internal" href="#conclusion" id="id9">Conclusion</a></li>
<li><a class="reference internal" href="#references" id="id10">References</a></li>
</ul>
</div>
<div class="section" id="environment">
<h2><a class="toc-backref" href="#contents">Environment</a><a class="headerlink" href="#environment" title="Permalink to this headline">¶</a></h2>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">specify that a little</p>
</div>
<ul class="simple">
<li>only Ubuntu 14.04 because of <em>synthesize</em></li>
<li>virtual machine hosted by digital ocean</li>
<li>only PoC, not productive</li>
</ul>
</div>
<div class="section" id="step-by-step">
<h2><a class="toc-backref" href="#contents">Step-by-Step</a><a class="headerlink" href="#step-by-step" title="Permalink to this headline">¶</a></h2>
<p>change the timezone to UTC-0, everything else is confusing:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ dpkg-reconfigure tzdata
</pre></div>
</div>
<p>We need git to clone the helper scripts:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ apt-get install -y git
</pre></div>
</div>
<p><em>Synthesize</em> <a class="footnote-reference" href="#id4" id="id1">[1]</a> installs statsd and graphite for us:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ mkdir /opt/synthesize
$ <span class="nb">cd</span> /opt/synthesize
$ git clone https://github.com/obfuscurity/synthesize
$ <span class="nb">cd</span> /opt/synthesize/synthesize
$ ./install
</pre></div>
</div>
<p>Install <code class="docutils literal"><span class="pre">grafana</span></code> from package <a class="footnote-reference" href="#id5" id="id2">[2]</a> (it&#8217;s not in the official repos):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ wget https://grafanarel.s3.amazonaws.com/builds/grafana_2.6.0_amd64.deb
$ apt-get install -y adduser libfontconfig
$ dpkg -i grafana_2.6.0_amd64.deb
</pre></div>
</div>
<p>Allow anonymous access with <em>viewer</em> rights <a class="footnote-reference" href="#id6" id="id3">[3]</a>. Users which are <em>not</em> logged
in can create dashboards but cannot save them.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ vim /etc/grafana/grafana.ini
</pre></div>
</div>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[auth.anonymous]</span>
<span class="na">enabled</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">org_role</span> <span class="o">=</span> <span class="s">viewer</span>
</pre></div>
</div>
<p>Everything is set up, start the engines:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ service grafana-server start
</pre></div>
</div>
<p>Open the grafana dashboard with your browser and use port <code class="docutils literal"><span class="pre">3000</span></code> in the URL.
That&#8217;s the admin URL which is necessary to save your created dashboards.</p>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p class="last">Add an annotated picture here, the list is bad</p>
</div>
<p>Add as datasource:</p>
<ul class="simple">
<li>Name: my-graphite</li>
<li>Type: Graphite</li>
<li>Url: <a class="reference external" href="https://127.0.0.01">https://127.0.0.01</a></li>
<li>Access: proxy</li>
<li>Basic Auth: checked</li>
<li>With Credentials: checked</li>
<li>User: admin</li>
<li>Password: graphite_me_synthesize</li>
</ul>
<p>The Grafana dashboard is intuitive and you can build graphs easily.
There are already some metrics about the host machine.</p>
<div class="admonition-todo admonition" id="index-3">
<p class="first admonition-title">Todo</p>
<p class="last">show an example query in Grafana here to give a hint</p>
</div>
<p>You can also access the web UI of the underlying <em>graphite</em> at
port <code class="docutils literal"><span class="pre">80</span></code>. The hierarchy of the metrics is shown there in a nice
way.</p>
<p>If you want to push your own metrics, below is an example.
It queries information about <em>OpenStack Nova</em> bugs from Launchpad and
pushes it to <em>statsd</em>. It&#8217;s a simplified version of a PoC I made
which I intend to make part of <a class="reference external" href="http://grafana.openstack.org/">http://grafana.openstack.org/</a>.
The key parts of the code are highlighted.</p>
<p>Install these prerequisites before we go to the script:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ pip install launchpadlib
$ pip install python-statsd
</pre></div>
</div>
<p>Create the folder for the statsd script:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ mkdir /opt/lp_stats
$ <span class="nb">cd</span> /opt/lp_stats
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-4">
<p class="first admonition-title">Todo</p>
<p class="last">double-check if this code works</p>
</div>
<p>Get the script <code class="docutils literal"><span class="pre">bug_stats.py</span></code> which creates the statsd data</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">launchpadlib.launchpad</span> <span class="kn">import</span> <span class="n">Launchpad</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="hll"><span class="kn">import</span> <span class="nn">statsd</span>
</span><span class="kn">import</span> <span class="nn">sys</span>


<span class="k">class</span> <span class="nc">BugStatsCollector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Collect bug stats by Launchpad project name &quot;&quot;&quot;</span>

    <span class="n">LP_IMPORTANCES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Undecided&quot;</span><span class="p">,</span> <span class="s2">&quot;Wishlist&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;Medium&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Critical&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>

        <span class="n">cachedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.launchpadlib/cache/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cachedir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="mi">0</span><span class="n">o700</span><span class="p">)</span>
        <span class="n">launchpad</span> <span class="o">=</span> <span class="n">Launchpad</span><span class="o">.</span><span class="n">login_anonymously</span><span class="p">(</span><span class="s1">&#39;bugstats&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;production&#39;</span><span class="p">,</span>
                                                <span class="n">cachedir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">launchpad</span><span class="o">.</span><span class="n">projects</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_open_by_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the stats for open bugs, separated by importance.</span>

<span class="sd">        :rtype: list of 2-tuple key-value pairs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">importance_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">importance</span> <span class="ow">in</span> <span class="n">BugStatsCollector</span><span class="o">.</span><span class="n">LP_IMPORTANCES</span><span class="p">:</span>
            <span class="n">bug_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">searchTasks</span><span class="p">(</span>
                <span class="n">status</span><span class="o">=</span><span class="n">BugStatsCollector</span><span class="o">.</span><span class="n">LP_OPEN_STATUSES</span><span class="p">,</span>
                <span class="n">importance</span><span class="o">=</span><span class="n">importance</span><span class="p">,</span>
                <span class="n">omit_duplicates</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">stats_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_valid_stat_key_name</span><span class="p">(</span><span class="n">importance</span><span class="p">)</span>
            <span class="n">stats_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_bug_tasks</span><span class="p">(</span><span class="n">bug_tasks</span><span class="p">)</span>
            <span class="n">stat</span> <span class="o">=</span><span class="p">(</span><span class="n">stats_key</span><span class="p">,</span> <span class="n">stats_value</span><span class="p">)</span>
            <span class="n">importance_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">importance_stats</span>

    <span class="k">def</span> <span class="nf">_get_valid_stat_key_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">stat_key</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">stat_key</span> <span class="o">=</span> <span class="n">stat_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">stat_key</span> <span class="o">=</span> <span class="n">stat_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">stat_key</span> <span class="o">=</span> <span class="n">stat_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stat_key</span>

    <span class="k">def</span> <span class="nf">_count_bug_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bug_tasks</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">bug_tasks</span><span class="o">.</span><span class="n">_wadl_resource</span><span class="o">.</span><span class="n">representation</span><span class="p">[</span><span class="s1">&#39;total_size&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">push_to_statsd</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">bug_stats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;push bug statistics to statsd on this host machine</span>

<span class="sd">    :param metric_name: The name of the metric</span>
<span class="sd">    :param bug_stats: list of 2-tuple key-value pairs to push</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="hll">    <span class="n">gauge</span> <span class="o">=</span> <span class="n">statsd</span><span class="o">.</span><span class="n">Gauge</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
</span>    <span class="k">for</span> <span class="n">bug_stat</span> <span class="ow">in</span> <span class="n">bug_stats</span><span class="p">:</span>
<span class="hll">        <span class="n">gauge</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bug_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bug_stat</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">projects</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nova&#39;</span><span class="p">,</span> <span class="s1">&#39;python-novaclient&#39;</span><span class="p">,</span> <span class="s1">&#39;cinder&#39;</span><span class="p">,</span> <span class="s1">&#39;neutron&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="n">projects</span><span class="p">:</span>
        <span class="n">collector</span> <span class="o">=</span> <span class="n">BugStatsCollector</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>
        <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;launchpad.bugs.</span><span class="si">%s</span><span class="s1">.open-by-importance&#39;</span> <span class="o">%</span> <span class="n">project_name</span>
        <span class="n">bug_stats</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">get_open_by_importance</span><span class="p">()</span>
        <span class="n">push_to_statsd</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">bug_stats</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>This script will create this hierarchy in <em>graphite</em>:</p>
<a class="reference external image-reference" href="../../_images/graphite_gauges.jpg"><img alt="The statsd gauges displayed in graphite" src="../../_images/graphite_gauges.jpg" /></a>
<div class="admonition-todo admonition" id="index-5">
<p class="first admonition-title">Todo</p>
<p class="last">replace that above with a picture from graphite</p>
</div>
<p>The leaves of this tree will be filled with the values we provide attached
to a timestamp <em>statsd</em> will get from the host. That&#8217;s why setting the
timezone from the beginning is important. Running this script multiple times
will create the time series data we want to visualize with <em>Grafana</em>.</p>
<p>Run <code class="docutils literal"><span class="pre">bug_stats.py</span></code> in an interval of 5 minutes as <code class="docutils literal"><span class="pre">nohup</span></code> to avoid
interruption when the SSH session terminates:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ nohup watch -n <span class="m">300</span> python bug_stats.py <span class="p">&amp;</span>
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#contents">Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>Provided with the steps above you should get a running playground in around
15 minutes. All the pieces work together without any fakes or mocks. Playing
around with your custom time series data and its visualization with <em>Grafana</em>
for PoCs should now be easier.</p>
</div>
<div class="section" id="references">
<h2><a class="toc-backref" href="#contents">References</a><a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://github.com/obfuscurity/synthesize/">https://github.com/obfuscurity/synthesize/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://docs.grafana.org/installation/debian/">http://docs.grafana.org/installation/debian/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="http://docs.grafana.org/installation/configuration/">http://docs.grafana.org/installation/configuration/</a></td></tr>
</tbody>
</table>
</div>
</div>

  <div class="section">
  
    


  
  
  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../">Blog</a></h1>









  <h3><a href="../">Recent Posts</a></h3>
  <ul>
    
    
      <li><a href="../openstack-bugs/">Dec 01 - OpenStack's Bug Management</a></li>
    
  </ul>

  <h3><a href="../tag/">Tags</a></h3>
  <style type="text/css">
    ul.ablog-cloud {list-style: none; overflow: auto;}
    ul.ablog-cloud li {float: left; height: 20pt; line-height: 18pt; margin-right: 5px;}
    ul.ablog-cloud a {text-decoration: none; vertical-align: middle;}
    li.ablog-cloud-1{font-size: 80%;}
    li.ablog-cloud-2{font-size: 95%;}
    li.ablog-cloud-3{font-size: 110%;}
    li.ablog-cloud-4{font-size: 125%;}
    li.ablog-cloud-5{font-size: 140%;}
  </style>
  <ul class="ablog-cloud">
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../tag/bugs/">bugs</a></li>
      
    
      
    
      
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../tag/openstack/">openstack</a></li>
      
    
  </ul>

  <h3><a href="../archive/">Archives</a></h3>
  <ul>
  
    
    <li><a href="../2015/">2015 (1)</a></li>
    
  
  </ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Markus Zoeller.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
      |
      <a href="../../_sources/posts/grafana-graphite-statsd.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>