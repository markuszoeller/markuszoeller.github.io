<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>OpenStack Nova Scheduling based on CPU architecture &#8212; Blog  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../about/" />
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
  
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  
  <link rel="alternate" type="application/atom+xml"  href="../../../posts/atom.xml" title="Markus's Brain Swap Space">
  
  
  <link href="True" rel="stylesheet">
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="openstack-nova-scheduling-based-on-cpu-architecture">
<h1>OpenStack Nova Scheduling based on CPU architecture<a class="headerlink" href="#openstack-nova-scheduling-based-on-cpu-architecture" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#tl-dr" id="id8">TL;DR</a></li>
<li><a class="reference internal" href="#use-case" id="id9">Use Case</a></li>
<li><a class="reference internal" href="#guest-image-metadata-properties" id="id10">Guest image metadata properties</a></li>
<li><a class="reference internal" href="#impact-to-the-nova-scheduler" id="id11">Impact to the Nova scheduler</a></li>
<li><a class="reference internal" href="#references" id="id12">References</a></li>
</ul>
</div>
<p>Change history:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Date</th>
<th class="head">Change description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>2017-??-??</td>
<td>The first release</td>
</tr>
</tbody>
</table>
<div class="section" id="tl-dr">
<h2><a class="toc-backref" href="#contents">TL;DR</a><a class="headerlink" href="#tl-dr" title="Permalink to this headline">¶</a></h2>
<p>Use <code class="docutils literal"><span class="pre">hw_architecture</span></code> instead of <code class="docutils literal"><span class="pre">architecture</span></code>.</p>
<ul>
<li><p class="first">OpenStack CLI:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ openstack image set &lt;IMG-UUID&gt; --property hw_architecture=s390x
</pre></div>
</div>
</li>
<li><p class="first">Ansible module <em>os_image</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Upload bootable s390x guest image into Glance.&quot;</span>
  <span class="n">os_image</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">ubuntu_s390x</span>
    <span class="n">filename</span><span class="p">:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ubuntu_s390x_disk</span><span class="o">.</span><span class="n">img</span>
    <span class="n">container_format</span><span class="p">:</span> <span class="n">bare</span>
    <span class="n">disk_format</span><span class="p">:</span> <span class="n">raw</span>
    <span class="n">properties</span><span class="p">:</span>
      <span class="n">hw_architecture</span><span class="p">:</span> <span class="n">s390x</span>
</pre></div>
</div>
</li>
</ul>
<p>If that TL;DR doesn&#8217;t make sense to you, below is the longer version.</p>
</div>
<div class="section" id="use-case">
<h2><a class="toc-backref" href="#contents">Use Case</a><a class="headerlink" href="#use-case" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s assume you have set up an OpenStack cloud with compute nodes
of different CPU architectures. For example, some Intel x86 compute nodes,
some IBM Z s390x compute nodes (and maybe some IBM POWER ppc64 compute
nodes). Those architectures need guest images which were built for those
architectures. All an OpenStack user sees, is the 3 different guest images</p>
<ul class="simple">
<li>suse_X  (SUSE guest image for Intel x86 64 bit operating system)</li>
<li>ubuntu_Z  (Ubuntu guest image for IBM Z s390x 64 bit operating system)</li>
<li>rhel_P  (RHEL guest image for IBM POWER ppc64 64 bit operating system)</li>
</ul>
<p>for example. The openstack user doesn&#8217;t see (and doesn&#8217;t need to and shouldn&#8217;t)
the details of the different compute nodes. All they want is that this
architecture specific image gets scheduled on the compute node which can
fulfil their needs.</p>
</div>
<div class="section" id="guest-image-metadata-properties">
<h2><a class="toc-backref" href="#contents">Guest image metadata properties</a><a class="headerlink" href="#guest-image-metadata-properties" title="Permalink to this headline">¶</a></h2>
<p>The most reasonable way I know to do this, is to add Glance image metadata,
which specifies the CPU architecture of that image so that other services
can use that information. The one OpenStack service we need for that,
is the Nova scheduler service. Specifically one of its filters, the
<code class="docutils literal"><span class="pre">ImagePropertiesFilter</span></code>.</p>
<p>Unfortunately, the docs in Glance don&#8217;t make it <strong>that</strong> obvious which
value you have to set. You will most likely stumble upon the metadata
property <code class="docutils literal"><span class="pre">architecture</span></code>. The Glance docs <a class="footnote-reference" href="#id4" id="id1">[1]</a> say this:</p>
<blockquote>
<div><em>&#8220;The CPU architecture that must be supported by the hypervisor.</em>
<em>For example, x86_64, arm, or ppc64.&#8221;</em></div></blockquote>
<p>Sounds like the correct one for your use-case, right? The openstack CLI
also says to use this <a class="footnote-reference" href="#id5" id="id2">[2]</a>.</p>
<p>It gets a bit more confusing when you want to use the <em>Ansible</em> module
<em>os_image</em> for your <em>Infrastructure as Code (IaC)</em>. The example there
uses <code class="docutils literal"><span class="pre">cpu_arch</span></code>:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">os_image</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cirros</span>
    <span class="l l-Scalar l-Scalar-Plain">container_format</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bare</span>
    <span class="l l-Scalar l-Scalar-Plain">disk_format</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">qcow2</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="l l-Scalar l-Scalar-Plain">filename</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cirros-0.3.0-x86_64-disk.img</span>
    <span class="l l-Scalar l-Scalar-Plain">properties</span><span class="p p-Indicator">:</span>
<span class="hll">      <span class="l l-Scalar l-Scalar-Plain">cpu_arch</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">x86_64</span>
</span>      <span class="l l-Scalar l-Scalar-Plain">distro</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
</pre></div>
</td></tr></table></div>
<p>I&#8217;m not sure if that metadata property has any effect anywhere. It hadn&#8217;t
when I tested the Nova scheduling with it.</p>
</div>
<div class="section" id="impact-to-the-nova-scheduler">
<h2><a class="toc-backref" href="#contents">Impact to the Nova scheduler</a><a class="headerlink" href="#impact-to-the-nova-scheduler" title="Permalink to this headline">¶</a></h2>
<p>Long story short, I don&#8217;t know the history of how it happened, but the nova
scheduler filter we want to use needs the property to be named
<code class="docutils literal"><span class="pre">hw_architecture</span></code> <a class="footnote-reference" href="#id7" id="id3">[4]</a>.</p>
<p>When this is applied to the image, and a user launches that image,
the nova scheduler filters out hosts which don&#8217;t offer that CPU architecture.
You can see the filtering happening in the nova scheduler logs. The shortened
example below starts with 2 compute nodes, one x86 and the other s390x:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ grep filter /var/log/nova/nova-scheduler.log
<span class="hll">DEBUG nova.filters [...] Starting with 2 host(s)
</span>DEBUG nova.scheduler.filters.retry_filter [...] Re-scheduling is disabled host_passes
DEBUG nova.scheduler.filters.retry_filter [...] Re-scheduling is disabled host_passes
DEBUG nova.filters [...] Filter RetryFilter returned 2 host(s)
DEBUG nova.filters [...] Filter AvailabilityZoneFilter
DEBUG nova.filters [...] Filter RamFilter returned 2 host(s)
DEBUG nova.filters [...] Filter ComputeFilter returned 2 host(s)
DEBUG nova.filters [...] Filter ComputeCapabilitiesFilter returned 2 host(s)
DEBUG nova.scheduler.filters.image_props_filter [...]
<span class="hll">    Instance contains properties ImageMetaProps(hw_architecture=&#39;s390x&#39;,...)
</span><span class="hll">    that are not provided by the compute node
</span>DEBUG nova.scheduler.filters.image_props_filter [...] (cmpx1, cmpx1)
    ram: 142990MB disk: 91136MB io_ops: 0 instances: 0
    does not support requested instance_properties
<span class="hll">DEBUG nova.filters [...] Filter ImagePropertiesFilter returned 1 host(s)
</span></pre></div>
</td></tr></table></div>
<p>You&#8217;ll notice that the <code class="docutils literal"><span class="pre">ImagePropertiesFilter</span></code> removed the one compute
node which cannot fulfil the <code class="docutils literal"><span class="pre">ImageMetaProps</span></code>. We started with 2 hosts
and at the end only one host is an eligible target host for the Instance.</p>
</div>
<div class="section" id="references">
<h2><a class="toc-backref" href="#contents">References</a><a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html">https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="https://docs.openstack.org/python-openstackclient/latest/cli/command-objects/image.html#image-set">https://docs.openstack.org/python-openstackclient/latest/cli/command-objects/image.html#image-set</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td><a class="reference external" href="http://docs.ansible.com/ansible/latest/os_image_module.html">http://docs.ansible.com/ansible/latest/os_image_module.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[4]</a></td><td><a class="reference external" href="https://github.com/openstack/nova/blob/4a7502a5c9e84a8c8cef7f355d72425b26b8c379/nova/scheduler/filters/image_props_filter.py#L44">https://github.com/openstack/nova/blob/4a7502a5c9e84a8c8cef7f355d72425b26b8c379/nova/scheduler/filters/image_props_filter.py#L44</a></td></tr>
</tbody>
</table>
</div>
</div>

  <div class="section">
  
    


  
  
  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../">Blog</a></h1>









  <h3><a href="../../">Recent Posts</a></h3>
  <ul>
    
    
      <li><a href="../../2016/03/06/grafana-graphite-statsd/">Mar 06 - Setup Grafana + Graphite + Statsd</a></li>
    
      <li><a href="../../2015/12/01/openstack-bugs/">Dec 01 - OpenStack's Bug Management</a></li>
    
  </ul>

  <h3><a href="../../tag/">Tags</a></h3>
  <style type="text/css">
    ul.ablog-cloud {list-style: none; overflow: auto;}
    ul.ablog-cloud li {float: left; height: 20pt; line-height: 18pt; margin-right: 5px;}
    ul.ablog-cloud a {text-decoration: none; vertical-align: middle;}
    li.ablog-cloud-1{font-size: 80%;}
    li.ablog-cloud-2{font-size: 95%;}
    li.ablog-cloud-3{font-size: 110%;}
    li.ablog-cloud-4{font-size: 125%;}
    li.ablog-cloud-5{font-size: 140%;}
  </style>
  <ul class="ablog-cloud">
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../../tag/bugs/">bugs</a></li>
      
    
      
    
      
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../../tag/data-visualization/">data-visualization</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../../tag/how-to/">how-to</a></li>
      
    
      
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../../tag/openstack/">openstack</a></li>
      
    
      
    
  </ul>

  <h3><a href="../../archive/">Archives</a></h3>
  <ul>
  
    
    <li><a href="../../2016/">2016 (1)</a></li>
    
  
    
    <li><a href="../../2015/">2015 (1)</a></li>
    
  
  </ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search/" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Markus Zoeller.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../../../_sources/posts/drafts/openstack-cpu-arch-scheduling.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>