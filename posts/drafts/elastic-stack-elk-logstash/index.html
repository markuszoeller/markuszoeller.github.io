<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Elastic Stack (formerly ELK) - Logstash &#8212; Markus Zoeller Blog</title>
    
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/asciinema-player.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/js/asciinema-player.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../about/" />
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
  
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  
  <link rel="alternate" type="application/atom+xml"  href="../../../posts/atom.xml" title="Markus's Brain Swap Space">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../">
          MZIO</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../about/">About</a></li>
                <li><a href="../../category/">Categories</a></li>
                <li><a href="../../tag/">Tags</a></li>
                <li><a href="../../archive/">Archives</a></li>
                <li><a href="/posts/atom.xml"><i class='fa fa-rss-square' aria-hidden='true'></i></a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search/" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="elastic-stack-formerly-elk-logstash">
<h1>Elastic Stack (formerly ELK) - <em>Logstash</em><a class="headerlink" href="#elastic-stack-formerly-elk-logstash" title="Permalink to this headline"> </a></h1>
<p>abstract</p>
<p>Some notes:</p>
<ul class="simple">
<li>Logging as a Service with <em>Elastic</em> Cloud Enterprise</li>
<li>data flow pipelines (pipe to pipe to pipe)</li>
<li>independent pipelines in one <em>Logstash</em> instance</li>
<li>&#8220;beats&#8221; protocol</li>
<li>&#8220;event&#8221; is the primary unit which gets sent to <em>Logstash</em></li>
<li>&#8220;workers&#8221; scale out the processing</li>
<li>in-memory queue vs. persistent queue</li>
<li>&#8220;at least once&#8221; delivery (err on the side of duplication)</li>
<li>codecs serialize and deserialize</li>
<li><code class="docutils literal"><span class="pre">json_lines</span></code> codecs is available  # non-human</li>
<li><code class="docutils literal"><span class="pre">dissect</span></code> is the &#8220;smaller version&#8221; of <code class="docutils literal"><span class="pre">grok</span></code> (delimiter vs regex)</li>
<li><em>kibana</em> can monitor <em>Logstash</em> and <em>Elasticsearch</em>  # not sure</li>
<li><em>Logstash</em> has an external REST API for metrics</li>
</ul>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#intro" id="id6">Intro</a></li>
<li><a class="reference internal" href="#set-up-the-environment" id="id7">Set up the environment</a></li>
<li><a class="reference internal" href="#terms-and-concepts" id="id8">Terms and Concepts</a></li>
<li><a class="reference internal" href="#basic-interaction-with-es" id="id9">Basic Interaction with <em>Elasticsearch</em></a></li>
<li><a class="reference internal" href="#summary" id="id10">Summary</a></li>
<li><a class="reference internal" href="#references" id="id11">References</a></li>
</ul>
</div>
<table border="1" class="docutils" id="id5">
<caption><span class="caption-text">Change history:</span><a class="headerlink" href="#id5" title="Permalink to this table"> </a></caption>
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Date</th>
<th class="head">Change description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>TODO</td>
<td>The first release</td>
</tr>
</tbody>
</table>
<div class="section" id="intro">
<h2><a class="toc-backref" href="#contents">Intro</a><a class="headerlink" href="#intro" title="Permalink to this headline"> </a></h2>
<p>This is the second part of a multi-part series about the
<em>Elastic Stack</em> (formerly the <strong>ELK stack</strong>). This stack
consists of 3 parts:</p>
<ul class="simple">
<li><strong>storing data</strong> with <em>Elasticsearch</em></li>
<li><strong>ingesting data</strong> with <em>Logstash</em> (and/or <em>Beats</em>)</li>
<li><strong>visualizing data</strong> with <em>Kibana</em></li>
</ul>
<p>This post will focus on the second part, <em>Logstash</em>, ...</p>
</div>
<div class="section" id="set-up-the-environment">
<h2><a class="toc-backref" href="#contents">Set up the environment</a><a class="headerlink" href="#set-up-the-environment" title="Permalink to this headline"> </a></h2>
<p>To reproduce the steps in this post, you need to have installed locally:</p>
<ul class="simple">
<li><em>Vagrant</em> <a class="footnote-reference" href="#vagrinst" id="id1">[1]</a></li>
<li><em>Ansible</em> <a class="footnote-reference" href="#ansinst" id="id2">[2]</a></li>
<li><em>VirtualBox</em> <a class="footnote-reference" href="#vbinst" id="id3">[3]</a></li>
</ul>
<p>After these <strong>prerequisites</strong> are fulfilled:</p>
<ol class="arabic simple">
<li>download the compressed
<a class="reference download internal" href="../../../_downloads/elastic-stack-elk-logstash.tar.gz" download=""><code class="xref download docutils literal"><span class="pre">project</span> <span class="pre">source</span> <span class="pre">files</span></code></a>.</li>
<li>extract the archive</li>
<li>change to the <code class="docutils literal"><span class="pre">env</span></code> directory</li>
<li>start the <em>Vagrant</em> setup</li>
<li>use <em>Ansible</em> to configure the environment</li>
</ol>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ wget http://www.markusz.io/_downloads/elastic-stack-elk-logstash.tar.gz
$ tar -zxvf elastic-stack-elk-elasticsearch.tar.gz
$ <span class="nb">cd</span> env
$ vagrant up
$ ansible-playbook playbook.yml
</pre></div>
</td></tr></table></div>
<p>Your (truncated) output should look similar to this:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span>[...]

PLAY RECAP ********************************************************************
app1                       : ok=10   changed=6    unreachable=0    failed=0
app2                       : ok=10   changed=6    unreachable=0    failed=0
es1                        : ok=21   changed=17   unreachable=0    failed=0

Thursday 04 January 2018  16:29:04 +0100 (0:00:01.319)       0:02:06.741 ******
===============================================================================
Install python package manager. ---------------------------------------- 50.79s
Install JAVA runtime. -------------------------------------------------- 24.73s
Check if Elasticsearch is up an running. ------------------------------- 11.50s
Wait for SSH to be ready. ---------------------------------------------- 10.36s
Download file with checksum check. -------------------------------------- 9.31s
Install app requirements. ----------------------------------------------- 4.87s
Ensure system package cache is updated. --------------------------------- 4.46s
Unarchive the elasticsearch archive. ------------------------------------ 1.43s
Run example app. -------------------------------------------------------- 1.32s
Run elasticsearch as daemon. -------------------------------------------- 1.22s
Add our servers to the hosts file. -------------------------------------- 0.99s
Deploy example app to servers. ------------------------------------------ 0.88s
Ping each other via DNS names. ------------------------------------------ 0.77s
Gather some facts for later. -------------------------------------------- 0.62s
Creating user for Elasticsearch group. ---------------------------------- 0.37s
Create a group for Elasticsearch. --------------------------------------- 0.32s
Disable all swapping. --------------------------------------------------- 0.32s
Create logging directory. ----------------------------------------------- 0.31s
Set maximum number of memory map areas (permanently). ------------------- 0.29s
Set number of open file descriptors (permanently). ---------------------- 0.28s
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">After you decided that you don&#8217;t need this environment anymore,
you can remove it with <code class="docutils literal"><span class="pre">vagrant</span> <span class="pre">destroy</span> <span class="pre">-f</span></code></p>
</div>
<p>This created a <strong>virtualized environment</strong> which looks like this:</p>
<a class="reference internal image-reference" href="../../../_images/elasticsearch-env-nF4AMyX1.svg"><img alt="*Vagrant* environment with virtual machines." src="../../../_images/elasticsearch-env-nF4AMyX1.svg" /></a>
<ul class="simple">
<li>one central logging server <code class="docutils literal"><span class="pre">es1</span></code></li>
<li>two application servers <code class="docutils literal"><span class="pre">app1</span></code> and <code class="docutils literal"><span class="pre">app2</span></code></li>
<li><em>Ubuntu 16.04</em> as operating system</li>
<li>Java <em>Open JDK</em> in version 8</li>
<li><em>Elasticsearch</em> in version 6.1</li>
</ul>
<p>While the setup goes on for a minute or two, let&#8217;s have a look at
a few basic terms and concepts of <em>Elasticsearch</em>.</p>
</div>
<div class="section" id="terms-and-concepts">
<h2><a class="toc-backref" href="#contents">Terms and Concepts</a><a class="headerlink" href="#terms-and-concepts" title="Permalink to this headline"> </a></h2>
<p>Let&#8217;s start with an overview of the basic <strong>concepts</strong> <a class="footnote-reference" href="#concepts" id="id4">[4]</a>.
I&#8217;ll explain the details after this image:</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">TODO</p>
</div>
</div>
<div class="section" id="basic-interaction-with-es">
<h2><a class="toc-backref" href="#contents">Basic Interaction with <em>Elasticsearch</em></a><a class="headerlink" href="#basic-interaction-with-es" title="Permalink to this headline"> </a></h2>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">TODO</p>
</div>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#contents">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline"> </a></h2>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p class="last">TODO</p>
</div>
</div>
<div class="section" id="references">
<h2><a class="toc-backref" href="#contents">References</a><a class="headerlink" href="#references" title="Permalink to this headline"> </a></h2>
<table class="docutils footnote" frame="void" id="vagrinst" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://www.vagrantup.com/docs/installation/">https://www.vagrantup.com/docs/installation/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ansinst" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://docs.ansible.com/ansible/latest/intro_installation.html">http://docs.ansible.com/ansible/latest/intro_installation.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="vbinst" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="concepts" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.1/_basic_concepts.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.1/_basic_concepts.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="lucene" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[5]</td><td><a class="reference external" href="https://lucene.apache.org/">https://lucene.apache.org/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="commonapi" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[6]</td><td><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.1/common-options.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.1/common-options.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="yamllist" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[7]</td><td><a class="reference external" href="http://www.yaml.org/spec/1.2/spec.html#id2797382">http://www.yaml.org/spec/1.2/spec.html#id2797382</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="esversion" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[8]</td><td><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.1/docs-index_.html#index-versioning">https://www.elastic.co/guide/en/elasticsearch/reference/6.1/docs-index_.html#index-versioning</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="esindexdis" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[9]</td><td><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.1/docs-index_.html#index-creation">https://www.elastic.co/guide/en/elasticsearch/reference/6.1/docs-index_.html#index-creation</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="esindexcreate" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[10]</td><td><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.1/indices-create-index.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.1/indices-create-index.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="flask" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[11]</td><td><a class="reference external" href="http://flask.pocoo.org/">http://flask.pocoo.org/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="pylog" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[12]</td><td><a class="reference external" href="https://docs.python.org/2/howto/logging.html#logging-basic-tutorial">https://docs.python.org/2/howto/logging.html#logging-basic-tutorial</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="pylogrot" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[13]</td><td><a class="reference external" href="https://docs.python.org/2/library/logging.handlers.html#logging.handlers.RotatingFileHandler">https://docs.python.org/2/library/logging.handlers.html#logging.handlers.RotatingFileHandler</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="essearch" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[14]</td><td><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/search.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="rsyslog" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[15]</td><td><a class="reference external" href="http://www.rsyslog.com/">http://www.rsyslog.com/</a></td></tr>
</tbody>
</table>
</div>
</div>

  <div class="section">
  
    


  
  
  </div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015-2018, Markus Zoeller.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>