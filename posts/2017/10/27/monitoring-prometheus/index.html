<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Monitoring with Prometheus &#8212; Markus Zoeller Blog</title>
    
    <link rel="stylesheet" href="../../../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/css/asciinema-player.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/asciinema-player.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../../about/" />
    <link rel="index" title="Index" href="../../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../../search/" />
  
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  
  <link rel="alternate" type="application/atom+xml"  href="../../../../../posts/atom.xml" title="Markus's Brain Swap Space">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../../">
          MZIO</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../../../about/">About</a></li>
                <li><a href="../../../../category/">Categories</a></li>
                <li><a href="../../../../tag/">Tags</a></li>
                <li><a href="../../../../archive/">Archive</a></li>
                <li><a href="/posts/atom.xml"><i class='fa fa-rss-square' aria-hidden='true'></i></a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../../">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../../search/" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="monitoring-with-prometheus">
<h1>Monitoring with Prometheus<a class="headerlink" href="#monitoring-with-prometheus" title="Permalink to this headline"> </a></h1>
<p>One of the common causes for service degradation or interruption is still
the failure or exhaustion of your basic infrastructure resources.
This post gives you an intro how you can monitor your basic resources
with <em>Prometheus</em>. It shows the setup with <em>Ansible</em> and the data visualization
with <em>Grafana</em>. The post does <strong>not</strong> show all the capabilities of <em>Prometheus</em>.
In fact, I&#8217;m showing you only the simplest configuration. The benefit
of this post is, that it takes you from start to finish and gives you
a playground you can easily recreate when things go wrong, thanks to
<em>Vagrant</em> and <em>VirtualBox</em>. Beware, as this is a non-trivial (non-hello-world)
example, this post is really long.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#tl-dr" id="id13">TL;DR</a></li>
<li><a class="reference internal" href="#use-case" id="id14">Use Case</a></li>
<li><a class="reference internal" href="#setup-overview" id="id15">Setup Overview</a></li>
<li><a class="reference internal" href="#server-provisioning" id="id16">Server Provisioning</a><ul>
<li><a class="reference internal" href="#vagrant" id="id17">Vagrant</a></li>
<li><a class="reference internal" href="#ansible-hosts" id="id18">Ansible hosts</a></li>
<li><a class="reference internal" href="#ansible-playbook" id="id19">Ansible playbook</a></li>
<li><a class="reference internal" href="#prometheus" id="id20">Prometheus</a></li>
<li><a class="reference internal" href="#grafana" id="id21">Grafana</a></li>
</ul>
</li>
<li><a class="reference internal" href="#monitor-the-metrics" id="id22">Monitor the metrics</a></li>
<li><a class="reference internal" href="#conclusion" id="id23">Conclusion</a></li>
<li><a class="reference internal" href="#references" id="id24">References</a></li>
<li><a class="reference internal" href="#appendix" id="id25">Appendix</a></li>
</ul>
</div>
<table border="1" class="docutils" id="id12">
<caption><span class="caption-text">Change history:</span><a class="headerlink" href="#id12" title="Permalink to this table"> </a></caption>
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Date</th>
<th class="head">Change description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>2017-10-27</td>
<td>The first release</td>
</tr>
</tbody>
</table>
<div class="section" id="tl-dr">
<h2><a class="toc-backref" href="#contents">TL;DR</a><a class="headerlink" href="#tl-dr" title="Permalink to this headline"> </a></h2>
<p>The short version of actions you have to do is:</p>
<ol class="arabic">
<li><p class="first">download the archive and extract the
<a class="reference download internal" href="../../../../../_downloads/monitoring-with-prometheus-source.tar.gz" download=""><code class="xref download docutils literal"><span class="pre">project</span> <span class="pre">source</span> <span class="pre">files</span></code></a></p>
</li>
<li><p class="first">ensure you have installed: <em>Vagrant</em>, <em>VirtualBox</em> and <em>Ansible</em></p>
</li>
<li><p class="first">execute these steps in the console:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span> $ vagrant up                                    <span class="c1"># create the servers</span>
 $ ansible-playbook -i hosts.ini playbook.yml    <span class="c1"># establish monitoring</span>
 $ vagrant ssh app-server-1                      <span class="c1"># log into VM</span>
 vagrant@app-server-1:~$ sudo su -               <span class="c1"># become root user</span>
 root@app-server-1:~# python eat_cpu.py <span class="p">&amp;</span>        <span class="c1"># start demo application</span>
</pre></div>
</td></tr></table></div>
</li>
</ol>
<p>Open your browser at <a class="reference external" href="http://192.168.100.10:3000/">http://192.168.100.10:3000/</a> and see the impact of
the demo application code. That&#8217;s it. The next sections describe the steps
in more detail.</p>
</div>
<div class="section" id="use-case">
<h2><a class="toc-backref" href="#contents">Use Case</a><a class="headerlink" href="#use-case" title="Permalink to this headline"> </a></h2>
<p>One of the worst calls you can get as operator, is one from the user
who complains that the service is slow or &#8211; even worse &#8211; doesn&#8217;t
respond anymore. A user should <strong>never know before you</strong>, that your
service doesn&#8217;t behave in its parameters anymore.</p>
<p>Monitoring is a way of collecting and storing data (so called <em>metrics</em>)
so that you can extrapolate a trend out of the historic view, to give
you insights if preemptive actions are necessary to keep your promised
<em>Service Level Agreements</em> (SLAs).</p>
<p>This post will focus on the monitoring aspect of the resources your
service can consume. Specifically, I&#8217;ll go into details of monitoring:</p>
<ul class="simple">
<li>CPU</li>
<li>memory</li>
<li>disk space</li>
</ul>
<p>For example, if you don&#8217;t use <em>logrotation</em>, it&#8217;s easy to consume all
disk space and become unserviceable (see my older post <a class="reference internal" href="../../../09/29/logrotate/#logrotate"><span class="std std-ref">Basics about Logrotate</span></a>).
A bug in the thread handling can also exhaust your CPU cycles. And a good
old memory leak is never out of fashion.</p>
<p>I cannot stress enough that having historic data is very valuable (if not to
say, essential). A single point in time observation is not enough.
A specialized type of data store, called <em>time series database</em>, is needed.</p>
<p>The show case here will use a demo setup, which is explained below.</p>
</div>
<div class="section" id="setup-overview">
<h2><a class="toc-backref" href="#contents">Setup Overview</a><a class="headerlink" href="#setup-overview" title="Permalink to this headline"> </a></h2>
<p>Our end result will look like this:</p>
<a class="reference external image-reference" href="/_images/topology.svg"><img alt="The topology of our demo setup." src="../../../../../_images/topology.svg" /></a>
<dl class="docutils">
<dt>We will have 3 servers:</dt>
<dd><ul class="first last simple">
<li>one monitoring server</li>
<li>two application server (observed by the monitoring node)</li>
</ul>
</dd>
</dl>
<p>We will deploy small applications which consume different types of resources
onto the application servers. This will demonstrate the influence on the
collected metrics, which are stored on the monitoring server within <em>Prometheus</em>.</p>
<p>You need several code files to repeat the actions in this post.
Use the full list of files below (or
<a class="reference download internal" href="../../../../../_downloads/monitoring-with-prometheus-source.tar.gz" download=""><code class="xref download docutils literal"><span class="pre">the</span> <span class="pre">compressed</span> <span class="pre">archive</span></code></a>):</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">eat_cpu.py</span></code> <a class="reference download internal" href="../../../../../_downloads/eat_cpu.py" download=""><code class="xref download docutils literal"><span class="pre">(download)</span></code></a>
Demo application code to consume CPU cycles.</li>
<li><code class="docutils literal"><span class="pre">eat_memory.py</span></code> <a class="reference download internal" href="../../../../../_downloads/eat_memory.py" download=""><code class="xref download docutils literal"><span class="pre">(download)</span></code></a>
Demo application code to consume RAM.</li>
<li><code class="docutils literal"><span class="pre">eat_disk.py</span></code> <a class="reference download internal" href="../../../../../_downloads/eat_disk.py" download=""><code class="xref download docutils literal"><span class="pre">(download)</span></code></a>
Demo application code to consume disk space.</li>
<li><code class="docutils literal"><span class="pre">Vagrantfile</span></code> <a class="reference download internal" href="../../../../../_downloads/Vagrantfile" download=""><code class="xref download docutils literal"><span class="pre">(download)</span></code></a>
Virtual environment description file (depends on <em>VirtualBox</em>)</li>
<li><code class="docutils literal"><span class="pre">prometheus.yml</span></code> <a class="reference download internal" href="../../../../../_downloads/prometheus.yml" download=""><code class="xref download docutils literal"><span class="pre">(download)</span></code></a>
<em>Prometheus</em> configuration file.</li>
<li><code class="docutils literal"><span class="pre">grafana.ini</span></code> <a class="reference download internal" href="../../../../../_downloads/grafana.ini" download=""><code class="xref download docutils literal"><span class="pre">(download)</span></code></a>
<em>Grafana</em> configuration file.</li>
<li><code class="docutils literal"><span class="pre">infra-node-metrics.json</span></code> <a class="reference download internal" href="../../../../../_downloads/infra-node-metrics.json" download=""><code class="xref download docutils literal"><span class="pre">(download)</span></code></a>
<em>Grafana</em> dashboard to visualize resource consumption.</li>
<li><code class="docutils literal"><span class="pre">hosts.ini</span></code> <a class="reference download internal" href="../../../../../_downloads/hosts.ini" download=""><code class="xref download docutils literal"><span class="pre">(download)</span></code></a>
<em>Ansible</em> target hosts file to operate on.</li>
<li><code class="docutils literal"><span class="pre">playbook.yml</span></code> <a class="reference download internal" href="../../../../../_downloads/playbook.yml" download=""><code class="xref download docutils literal"><span class="pre">(download)</span></code></a>
<em>Ansible</em> playbook to set up our environment.</li>
</ul>
<p>I will describe the files more in detail when I use them later.
If you&#8217;re less interested in the details and want to see the end result
first, you can jump to section <a class="reference internal" href="#monitoring-metrics"><span class="std std-ref">Monitor the metrics</span></a> and come back to
the details later.</p>
</div>
<div class="section" id="server-provisioning">
<h2><a class="toc-backref" href="#contents">Server Provisioning</a><a class="headerlink" href="#server-provisioning" title="Permalink to this headline"> </a></h2>
<p>To create the servers described before, I&#8217;ll utilize <em>Vagrant</em> with <em>VirtualBox</em> as
hypervisor. I use the term <em>provisioning</em> in the sense of creating the
servers and configuring the basic infra support functions (which includes
the monitoring). The configuration is done with <em>Ansible</em>. As described before
there are multiple files involved in this operation and they get explained
piece by piece below.</p>
<div class="admonition-feedback-needed admonition">
<p class="first admonition-title">Feedback needed</p>
<p class="last">Unfortunately, I haven&#8217;t yet found crisp, unambiguous terms
for the different phases, and <em>provisioning</em> and <em>deploying</em> is overloaded
and therefore ambiguous. If you have found good terms and definitions,
I&#8217;d be happy if you could leave me a comment on this post.</p>
</div>
<div class="section" id="vagrant">
<h3><a class="toc-backref" href="#contents">Vagrant</a><a class="headerlink" href="#vagrant" title="Permalink to this headline"> </a></h3>
<p>Let&#8217;s start with the <code class="docutils literal"><span class="pre">Vagrantfile</span></code>. This file is the input for <em>Vagrant</em>
and describes the basic structure of our environment. Typically, I have
three parts in a Vagrantfile:</p>
<ol class="arabic simple">
<li>an array which <strong>describes</strong> the servers and their attributes</li>
<li>some general hypervisor settings</li>
<li>the logic to <strong>create</strong> the servers from the array</li>
</ol>
<p>Lets take a look at the <strong>first part</strong>:</p>
<div class="highlight-ruby"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>

<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>

  <span class="c1"># =========================================================================</span>
  <span class="c1"># The servers in our environment</span>
  <span class="c1"># =========================================================================</span>
<span class="hll">  <span class="n">servers</span><span class="o">=[</span>
</span>    <span class="p">{</span>
      <span class="ss">:hostname</span> <span class="o">=&gt;</span> <span class="s2">&quot;monitoring&quot;</span><span class="p">,</span>
      <span class="ss">:box</span> <span class="o">=&gt;</span> <span class="s2">&quot;geerlingguy/ubuntu1604&quot;</span><span class="p">,</span>
      <span class="ss">:ip</span> <span class="o">=&gt;</span> <span class="s2">&quot;192.168.100.10&quot;</span><span class="p">,</span>
      <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="mi">50001</span><span class="p">,</span>
      <span class="ss">:ram</span> <span class="o">=&gt;</span> <span class="mi">1024</span><span class="p">,</span>
      <span class="ss">:cpu</span> <span class="o">=&gt;</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="ss">:hostname</span> <span class="o">=&gt;</span> <span class="s2">&quot;app-server-1&quot;</span><span class="p">,</span>
      <span class="ss">:box</span> <span class="o">=&gt;</span> <span class="s2">&quot;geerlingguy/ubuntu1604&quot;</span><span class="p">,</span>
      <span class="ss">:ip</span> <span class="o">=&gt;</span> <span class="s2">&quot;192.168.100.11&quot;</span><span class="p">,</span>
      <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="mi">50002</span><span class="p">,</span>
      <span class="ss">:ram</span> <span class="o">=&gt;</span> <span class="mi">1024</span><span class="p">,</span>
      <span class="ss">:cpu</span> <span class="o">=&gt;</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="ss">:hostname</span> <span class="o">=&gt;</span> <span class="s2">&quot;app-server-2&quot;</span><span class="p">,</span>
      <span class="ss">:box</span> <span class="o">=&gt;</span> <span class="s2">&quot;geerlingguy/ubuntu1604&quot;</span><span class="p">,</span>
      <span class="ss">:ip</span> <span class="o">=&gt;</span> <span class="s2">&quot;192.168.100.12&quot;</span><span class="p">,</span>
      <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="mi">50003</span><span class="p">,</span>
      <span class="ss">:ram</span> <span class="o">=&gt;</span> <span class="mi">1024</span><span class="p">,</span>
      <span class="ss">:cpu</span> <span class="o">=&gt;</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="o">]</span>
</pre></div>
</td></tr></table></div>
<p>You&#8217;ll notice that the three servers we mentioned in the previous section
get described here. I like the <em>Vagrant Box</em> from <code class="docutils literal"><span class="pre">geerlingguy</span></code>, as it
works better as the official one from <em>Canonical</em>. I use predefined private
IPs (and not DNS), as I feed these IPs later to <em>Ansible</em>. Sometimes I had issues
with host port clashes when working with multiple <em>Vagrant</em> environments at the
same time, so I usually predefine them as well. From time to time, I need
different amount of resources for a multi VM environment, so I added attributes
for CPUs and memory to my template as well.</p>
<p>The <strong>second part</strong> is this:</p>
<div class="highlight-ruby"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="c1"># =========================================================================</span>
  <span class="c1"># The general settings</span>
  <span class="c1"># =========================================================================</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
    <span class="c1"># https://www.vagrantup.com/docs/virtualbox/configuration.html#linked-clones</span>
    <span class="n">v</span><span class="o">.</span><span class="n">linked_clone</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
</pre></div>
</td></tr></table></div>
<p>I use a hypervisor specific feature from <em>VirtualBox</em> to speed things up a little.
When you destroy and create such an environment multiple times, this comes
in handy.</p>
<p>And the <strong>third part</strong> is this:</p>
<div class="highlight-ruby"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="c1"># =========================================================================</span>
  <span class="c1"># Server specific settings</span>
  <span class="c1"># =========================================================================</span>
<span class="hll">  <span class="n">servers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">machine</span><span class="o">|</span>
</span>    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="n">machine</span><span class="o">[</span><span class="ss">:hostname</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
      <span class="n">node</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">machine</span><span class="o">[</span><span class="ss">:box</span><span class="o">]</span>
      <span class="n">node</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">machine</span><span class="o">[</span><span class="ss">:hostname</span><span class="o">]</span>
      <span class="n">node</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="n">machine</span><span class="o">[</span><span class="ss">:ip</span><span class="o">]</span>
      <span class="n">node</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;forwarded_port&quot;</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="n">machine</span><span class="o">[</span><span class="ss">:port</span><span class="o">]</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;ssh&quot;</span>

      <span class="n">node</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
        <span class="n">vb</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">machine</span><span class="o">[</span><span class="ss">:ram</span><span class="o">]</span>
        <span class="n">vb</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="n">machine</span><span class="o">[</span><span class="ss">:cpu</span><span class="o">]</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></div>
<p>This iterates through the servers defined in the first part and applies
all the attributes we defined.</p>
<p>With this file locally in place, you can influence the life cycle of your
servers with <code class="docutils literal"><span class="pre">vagrant</span> <span class="pre">up</span></code> and <code class="docutils literal"><span class="pre">vagrant</span> <span class="pre">destroy</span></code>. To continue with
this post, start the servers with:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ vagrant up          <span class="c1"># create the servers</span>
</pre></div>
</td></tr></table></div>
<p>Now we are ready to deploy something onto those servers.</p>
</div>
<div class="section" id="ansible-hosts">
<h3><a class="toc-backref" href="#contents">Ansible hosts</a><a class="headerlink" href="#ansible-hosts" title="Permalink to this headline"> </a></h3>
<p>I&#8217;m going to use more and more <em>Ansible</em> examples in this blog, as this is my
tool of choice for such tasks. Doing such things with the shell looks smaller
and easier at first, but the more nodes you have, the more <em>Ansible</em> comes in handy.
If you haven&#8217;t tried it yet, give it a chance, it&#8217;s awesome.</p>
<p><em>Ansible</em> needs a file which specifies its targets to operate on. It uses the
<code class="docutils literal"><span class="pre">ini</span></code> syntax and you can name it whatever you want, I called it
<code class="docutils literal"><span class="pre">hosts.ini</span></code> throughout this post. The content is:</p>
<div class="highlight-ini"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">[infra-servers]</span>
<span class="na">monitoring ansible_host</span><span class="o">=</span><span class="s">192.168.100.10 ansible_user=vagrant ansible_ssh_pass=vagrant</span>

<span class="k">[application-servers]</span>
<span class="na">app-server-1 ansible_host</span><span class="o">=</span><span class="s">192.168.100.11 ansible_user=vagrant ansible_ssh_pass=vagrant</span>
<span class="na">app-server-2 ansible_host</span><span class="o">=</span><span class="s">192.168.100.12 ansible_user=vagrant ansible_ssh_pass=vagrant</span>
</pre></div>
</td></tr></table></div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Do <strong>not</strong> store passwords like that when using <em>Ansible</em>. Use the
<em>Ansible Vault</em> feature <a class="footnote-reference" href="#ansivault" id="id1">[1]</a> for that. I excluded it from the
scope of this post to keep it a bit more crisp.</p>
</div>
<p>You&#8217;ll recognize the servers we described in the <code class="docutils literal"><span class="pre">Vagrantfile</span></code> before.
If you don&#8217;t provide the <code class="docutils literal"><span class="pre">ansible_host</span></code> key-value-pair, a DNS name
resolution will be attempted.
As <em>Ansible</em> is <em>agentless</em> and uses plain SSH to access the targets, I used
the default credentials <em>Vagrant</em> creates when starting the servers. The servers
got separated into <em>groups</em> (or <code class="docutils literal"><span class="pre">*.ini</span></code> file sections). You can have groups of
groups too, which is is a powerful concept. These groups come in handy when
applying deployment logic based on these groups. The next section will
show that.</p>
</div>
<div class="section" id="ansible-playbook">
<h3><a class="toc-backref" href="#contents">Ansible playbook</a><a class="headerlink" href="#ansible-playbook" title="Permalink to this headline"> </a></h3>
<p><em>Ansible</em> uses <em>playbooks</em> to encapsulate deployment and server configuration logic.
One playbook can contain 1 to N <em>plays</em>. One <em>play</em> uses a group of servers
or a single server as a target. One <em>play</em> contains 1 to N <em>tasks</em>. A <em>task</em>
is the atomic building block and smallest unit of work in <em>Ansible</em>.</p>
<p>There is one <em>magic group</em> called <code class="docutils literal"><span class="pre">all</span></code>. This
includes all the servers in the target file we specified before. The syntax
in playbooks is <code class="docutils literal"><span class="pre">YAML</span></code> and the file we use is the <code class="docutils literal"><span class="pre">playbook.yml</span></code>. I used
one playbook to contain all necessary plays to keep it simple. Let&#8217;s go through
the plays piece by piece. I&#8217;ll show the code first and explain it below:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="c1"># ===========================================================================</span>
<span class="c1"># Do basic setup on all hosts</span>
<span class="c1"># ===========================================================================</span>
<span class="hll"><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
</span>  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
<span class="hll">    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Wait</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">SSH</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">be</span><span class="nv"> </span><span class="s">ready.&quot;</span>
</span>      <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
      <span class="l l-Scalar l-Scalar-Plain">delegate_to</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
      <span class="l l-Scalar l-Scalar-Plain">wait_for</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">22</span>
        <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="s">&#39;{{</span><span class="nv"> </span><span class="s">ansible_host</span><span class="nv"> </span><span class="s">}}&#39;</span>
        <span class="l l-Scalar l-Scalar-Plain">search_regex</span><span class="p p-Indicator">:</span> <span class="s">&quot;OpenSSH&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">delay</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">300</span>

<span class="hll">    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Add</span><span class="nv"> </span><span class="s">our</span><span class="nv"> </span><span class="s">servers</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">hosts</span><span class="nv"> </span><span class="s">file.&quot;</span>
</span>      <span class="l l-Scalar l-Scalar-Plain">lineinfile</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">dest</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/hosts</span>
        <span class="c1"># use the IP address we specified in the Vagrantfile</span>
        <span class="l l-Scalar l-Scalar-Plain">line</span><span class="p p-Indicator">:</span> <span class="s">&#39;{{</span><span class="nv"> </span><span class="s">hostvars[item].ansible_host</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">{{item}}&#39;</span>
      <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span> <span class="s">&#39;{{</span><span class="nv"> </span><span class="s">groups[&quot;all&quot;]</span><span class="nv"> </span><span class="s">}}&#39;</span>

<span class="hll">    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Ping</span><span class="nv"> </span><span class="s">each</span><span class="nv"> </span><span class="s">other</span><span class="nv"> </span><span class="s">via</span><span class="nv"> </span><span class="s">DNS</span><span class="nv"> </span><span class="s">names.&quot;</span>
</span>      <span class="l l-Scalar l-Scalar-Plain">ping</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span> <span class="s">&#39;{{</span><span class="nv"> </span><span class="s">groups[&quot;all&quot;]</span><span class="nv"> </span><span class="s">}}&#39;</span>

<span class="hll">    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Ensure</span><span class="nv"> </span><span class="s">system</span><span class="nv"> </span><span class="s">package</span><span class="nv"> </span><span class="s">cache</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">updated.&quot;</span>
</span>      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">update_cache</span><span class="p p-Indicator">:</span> <span class="s">&quot;yes&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">cache_valid_time</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">3600</span>
</pre></div>
</td></tr></table></div>
<p>This is the <strong>first play</strong> and we use the magic group <code class="docutils literal"><span class="pre">all</span></code> as a target.
As described before, that includes all servers. From reading the <code class="docutils literal"><span class="pre">name</span></code>
lines, you should get an idea <strong>what</strong> happens. You also see that I re-use
existing <em>Ansible</em> modules, namely <code class="docutils literal"><span class="pre">wait_for</span></code>, <code class="docutils literal"><span class="pre">lineinfile</span></code>, <code class="docutils literal"><span class="pre">ping</span></code> and
<code class="docutils literal"><span class="pre">apt</span></code>. I won&#8217;t go into the details of the modules I used.
A full list of modules is available at <a class="footnote-reference" href="#ansmods" id="id2">[2]</a>, take a look at them
for the details. The goal of this play is to have the servers ready
for deploying the monitoring and applications later.</p>
<p>Keep in mind that everything here happens inside the servers (if not
delegated, like I did here to wait for SSH).
When working with virtual machines which got created a few seconds earlier,
sometimes the SSH service is not fully ready when starting the playbooks,
that&#8217;s why I added a waiting logic.
<em>Prometheus</em> will later use DNS name resolution, that&#8217;s why I manipulated the
hosts file on these servers.</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># ===========================================================================</span>
<span class="c1"># Do setup on all hosts we want to monitor</span>
<span class="c1"># ===========================================================================</span>
<span class="hll"><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>  <span class="c1"># we want the metrics of the monitoring server too</span>
</span>  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
<span class="hll">    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Install</span><span class="nv"> </span><span class="s">Prometheus</span><span class="nv"> </span><span class="s">Node</span><span class="nv"> </span><span class="s">Exporter</span><span class="nv"> </span><span class="s">package.&quot;</span>
</span>      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus-node-exporter</span>

<span class="hll">    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Ensure</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Node</span><span class="nv"> </span><span class="s">Exporter</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">started</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">starts</span><span class="nv"> </span><span class="s">at</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">boot.&quot;</span>
</span>      <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus-node-exporter</span>
        <span class="l l-Scalar l-Scalar-Plain">enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>

<span class="hll">    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Check</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">service</span><span class="nv"> </span><span class="s">emits</span><span class="nv"> </span><span class="s">metrics.&quot;</span>
</span>      <span class="l l-Scalar l-Scalar-Plain">uri</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://127.0.0.1:9100/metrics</span>
        <span class="l l-Scalar l-Scalar-Plain">method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">GET</span>
        <span class="l l-Scalar l-Scalar-Plain">status_code</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200</span>
</pre></div>
</td></tr></table></div>
<p>After we have prepared the servers with the basic steps, we install
the operating system packaged version of one of many <em>Prometheus</em> exporters <a class="footnote-reference" href="#promex" id="id3">[3]</a>,
the <em>Prometheus-Node-Exporter</em>. This exporter emits the metrics we are
interested in. The <em>Prometheus</em> service will later collect the metrics from this URI.</p>
<p>I like to add small <em>&#8220;assert tasks&#8221;</em> which check conditions I expect to be there,
to fail fast if things go wrong. Here I do a simple HTTP GET request to see
if the exporter emits metrics.</p>
<p>Now that we have something to listen on, let&#8217;s install the rest of the
monitoring.</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># ===========================================================================</span>
<span class="c1"># Do prometheus server specific setup only on the monitoring server</span>
<span class="c1"># ===========================================================================</span>
<span class="hll"><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span>  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>


  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
    <span class="c1"># --- Prometheus --------------------------------------------------------</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Install</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Prometheus</span><span class="nv"> </span><span class="s">server.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Configure</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Prometheus</span><span class="nv"> </span><span class="s">server.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">copy</span><span class="p p-Indicator">:</span>
<span class="hll">        <span class="l l-Scalar l-Scalar-Plain">src</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus.yml</span>
</span>        <span class="l l-Scalar l-Scalar-Plain">dest</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/prometheus/prometheus.yml</span>
      <span class="l l-Scalar l-Scalar-Plain">notify</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">event_restart_prometheus</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Ensure</span><span class="nv"> </span><span class="s">Prometheus</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">started</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">starts</span><span class="nv"> </span><span class="s">at</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">boot.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus</span>
        <span class="l l-Scalar l-Scalar-Plain">enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Check</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">Prometheus</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">accessible.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">uri</span><span class="p p-Indicator">:</span>
<span class="hll">        <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://127.0.0.1:9090/graph</span>
</span>        <span class="l l-Scalar l-Scalar-Plain">method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">GET</span>
        <span class="l l-Scalar l-Scalar-Plain">status_code</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200</span>

    <span class="c1"># --- Grafana -----------------------------------------------------------</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Install</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Grafana</span><span class="nv"> </span><span class="s">server.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">grafana</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Copy</span><span class="nv"> </span><span class="s">Grafana</span><span class="nv"> </span><span class="s">configuration</span><span class="nv"> </span><span class="s">file.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">copy</span><span class="p p-Indicator">:</span>
<span class="hll">        <span class="l l-Scalar l-Scalar-Plain">src</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">grafana.ini</span>
</span>        <span class="l l-Scalar l-Scalar-Plain">dest</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/grafana/grafana.ini</span>
      <span class="l l-Scalar l-Scalar-Plain">notify</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">event_restart_grafana</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Ensure</span><span class="nv"> </span><span class="s">Grafana</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">started</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">starts</span><span class="nv"> </span><span class="s">at</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">boot.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">grafana</span>
        <span class="l l-Scalar l-Scalar-Plain">enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Check</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">Grafana</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">accessible.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">uri</span><span class="p p-Indicator">:</span>
<span class="hll">        <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://127.0.0.1:3000</span>
</span>        <span class="l l-Scalar l-Scalar-Plain">method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">GET</span>
        <span class="l l-Scalar l-Scalar-Plain">status_code</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Add</span><span class="nv"> </span><span class="s">Prometheus</span><span class="nv"> </span><span class="s">as</span><span class="nv"> </span><span class="s">datasource</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Grafana.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">prometheus_datasource</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;prometheus&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="s">&quot;prometheus&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="s">&quot;http://127.0.0.1:9090&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">access</span><span class="p p-Indicator">:</span> <span class="s">&quot;proxy&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">isDefault</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="l l-Scalar l-Scalar-Plain">basicAuth</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
      <span class="l l-Scalar l-Scalar-Plain">uri</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://127.0.0.1:3000/api/datasources</span>
        <span class="l l-Scalar l-Scalar-Plain">method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">POST</span>
        <span class="l l-Scalar l-Scalar-Plain">body</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">prometheus_datasource</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">to_json</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">body_format</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">json</span>
        <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
        <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
        <span class="l l-Scalar l-Scalar-Plain">force_basic_auth</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class="l l-Scalar l-Scalar-Plain">status_code</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200,500</span>  <span class="c1"># 500 means, the datasource is already added</span>
        <span class="l l-Scalar l-Scalar-Plain">headers</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">Content-Type</span><span class="p p-Indicator">:</span> <span class="s">&quot;application/json&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">Accept</span><span class="p p-Indicator">:</span> <span class="s">&quot;application/json&quot;</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Upload</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">example</span><span class="nv"> </span><span class="s">Grafana</span><span class="nv"> </span><span class="s">dashboard.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">uri</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://127.0.0.1:3000/api/dashboards/db</span>
        <span class="l l-Scalar l-Scalar-Plain">method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">POST</span>
<span class="hll">        <span class="l l-Scalar l-Scalar-Plain">body</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;file&#39;,</span><span class="nv"> </span><span class="s">&#39;infra-node-metrics.json&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span>        <span class="l l-Scalar l-Scalar-Plain">body_format</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">json</span>
        <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
        <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
        <span class="l l-Scalar l-Scalar-Plain">force_basic_auth</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class="l l-Scalar l-Scalar-Plain">status_code</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200</span>
        <span class="l l-Scalar l-Scalar-Plain">headers</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">Content-Type</span><span class="p p-Indicator">:</span> <span class="s">&quot;application/json&quot;</span>
          <span class="l l-Scalar l-Scalar-Plain">Accept</span><span class="p p-Indicator">:</span> <span class="s">&quot;application/json&quot;</span>


  <span class="c1"># --- After all tasks are executed (if notified) --------------------------</span>
<span class="hll">  <span class="l l-Scalar l-Scalar-Plain">handlers</span><span class="p p-Indicator">:</span>
</span>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Restart</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Prometheus</span><span class="nv"> </span><span class="s">service.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">restarted</span>
      <span class="l l-Scalar l-Scalar-Plain">listen</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">event_restart_prometheus</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Restart</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Grafana</span><span class="nv"> </span><span class="s">service.&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">grafana</span>
        <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">restarted</span>
      <span class="l l-Scalar l-Scalar-Plain">listen</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">event_restart_grafana</span>
</pre></div>
</td></tr></table></div>
<p>This is a big one. The important parts are highlighted. We apply this logic
only on the <code class="docutils literal"><span class="pre">monitoring</span></code> server. Three important files get used here:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">prometheus.yml</span></code> configures <em>Prometheus</em></li>
<li><code class="docutils literal"><span class="pre">grafana.ini</span></code> configures <em>Grafana</em></li>
<li><code class="docutils literal"><span class="pre">infra-node-metrics.json</span></code> example dashboard</li>
</ul>
<p>If you want to have a reproducible infrastructure, it&#8217;s good to save such
things in your version control system too. For the dashboard, I usually
create one in the <em>Grafana</em> web UI and use the export function to store the
generated JSON. Only for very small changes I edit the JSON file itself.</p>
<p>There are also again some tasks which assert that the services are up and
running. The <code class="docutils literal"><span class="pre">handlers</span></code> at the end get fired <strong>after</strong> the tasks are
finished and if a notification was triggered.</p>
<p>With this logic, we have the monitoring in place. But we need something
to have impact on our resources. We need applications:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># ===========================================================================</span>
<span class="c1"># Push the &quot;applications&quot; to the application servers</span>
<span class="c1"># ===========================================================================</span>
<span class="hll"><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">application-servers</span>
</span>  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Copy</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">applications</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">servers.&quot;</span>
       <span class="l l-Scalar l-Scalar-Plain">copy</span><span class="p p-Indicator">:</span>
         <span class="l l-Scalar l-Scalar-Plain">src</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
         <span class="l l-Scalar l-Scalar-Plain">dest</span><span class="p p-Indicator">:</span> <span class="s">&quot;/root/{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}&quot;</span>
       <span class="l l-Scalar l-Scalar-Plain">with_items</span><span class="p p-Indicator">:</span>
         <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">eat_cpu.py</span>
         <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">eat_disk.py</span>
         <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">eat_memory.py</span>
</pre></div>
</td></tr></table></div>
<p>A very simple and short one this time. The application code we copy here
is shown in <a class="reference internal" href="#appendix"><span class="std std-ref">Appendix</span></a>.</p>
<p>Now execute the playbook locally:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ ansible-playbook -i hosts.ini playbook.yml
</pre></div>
</td></tr></table></div>
<p>While this command does its magic, let&#8217;s have a look at the configuration
files we have copied to the monitoring node.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">It&#8217;s perfectly fine to start <em>Ansible</em> playbooks like I did here.
For example, when you transition from shell scripts. At some point in
time you should very strongly consider to encapsulated logic into
<em>Ansible roles</em> <a class="footnote-reference" href="#ansiroles" id="id4">[4]</a>. Think of them as re-usable libraries
with defined interfaces.</p>
</div>
</div>
<div class="section" id="prometheus">
<h3><a class="toc-backref" href="#contents">Prometheus</a><a class="headerlink" href="#prometheus" title="Permalink to this headline"> </a></h3>
<p>You have seen in the playbook before, that we copy a file called
<code class="docutils literal"><span class="pre">prometheus.yml</span></code>. This is what it does:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># The full config is at:</span>
<span class="c1">#   https://prometheus.io/docs/operating/configuration/</span>

<span class="l l-Scalar l-Scalar-Plain">global</span><span class="p p-Indicator">:</span>
  <span class="c1"># How frequently to scrape targets by default.</span>
  <span class="l l-Scalar l-Scalar-Plain">scrape_interval</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">15s</span>

<span class="hll"><span class="l l-Scalar l-Scalar-Plain">scrape_configs</span><span class="p p-Indicator">:</span>
</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">job_name</span><span class="p p-Indicator">:</span> <span class="s">&#39;monitoring&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">target_groups</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">targets</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;localhost:9100&#39;</span><span class="p p-Indicator">]</span>
        <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&#39;monitoring&#39;</span>
          <span class="l l-Scalar l-Scalar-Plain">owner</span><span class="p p-Indicator">:</span> <span class="s">&#39;mzio&#39;</span>

<span class="hll">  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">job_name</span><span class="p p-Indicator">:</span> <span class="s">&#39;app-server-1&#39;</span>
</span>    <span class="l l-Scalar l-Scalar-Plain">target_groups</span><span class="p p-Indicator">:</span>
<span class="hll">      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">targets</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;app-server-1:9100&#39;</span><span class="p p-Indicator">]</span>
</span>        <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
<span class="hll">          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&#39;app-server-1&#39;</span>
</span>          <span class="l l-Scalar l-Scalar-Plain">arch</span><span class="p p-Indicator">:</span> <span class="s">&#39;x86&#39;</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">job_name</span><span class="p p-Indicator">:</span> <span class="s">&#39;app-server-2&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">target_groups</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">targets</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;app-server-2:9100&#39;</span><span class="p p-Indicator">]</span>
        <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&#39;app-server-2&#39;</span>
          <span class="l l-Scalar l-Scalar-Plain">arch</span><span class="p p-Indicator">:</span> <span class="s">&#39;x86&#39;</span>
</pre></div>
</td></tr></table></div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">In newer versions of Prometheus, <code class="docutils literal"><span class="pre">target_groups</span></code> got replaced by
<code class="docutils literal"><span class="pre">static_configs</span></code> <a class="footnote-reference" href="#promstatic" id="id5">[5]</a> .</p>
</div>
<p>This is a static configuration, which only makes sense if your environment
does not change that often. There are more dynamic ones with service discovery,
but I won&#8217;t dive into that right now. The highlighted lines are the interesting
ones. The meaning of these lines piece by piece:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">scrape_configs</span></code>: The act of collecting (pulling) metrics from a source
is called <em>scraping</em> in <em>Prometheus</em> terms. We can have N scrape configurations.</li>
<li><code class="docutils literal"><span class="pre">job_name</span></code>: A <em>job</em>  abstracts 1 to N targets. For target specific
resources (like in this post), this seems unnecessary. Imagine HTTP response
times of your distributed, highly available application on the other hand.
Then you don&#8217;t care about a single HTTP server, but in the combined metrics.
A job name could then be <em>&#8220;web-ui-app-x&#8221;</em> with multiple targets. I plan to
write a post about <code class="docutils literal"><span class="pre">HAProxy</span></code> at some point, it will make more sense then.</li>
<li><code class="docutils literal"><span class="pre">targets</span></code>: A <em>scrape job</em> can have multiple targets. We could have added
both application servers here, but then both would get the same labels
applied. The labels are one of the nice things of <em>Prometheus</em> which distinguishes
it from other monitoring software like <em>statsd</em>.</li>
<li><code class="docutils literal"><span class="pre">name</span></code>: This is simply an arbitrarily chosen free-form label. Labels give
you the ability to <em>tag</em> / <em>mark</em> / <em>annotate</em> your metrics. These
values can later get used to set constraints in the <em>Prometheus</em> query language.</li>
</ul>
<p>The best metrics don&#8217;t help, if you can&#8217;t pull knowledge out of them and
derive actions from that knowledge. Visualizing data is the best method
(for me) to create knowledge from data, and <em>Grafana</em> does a very good job
at data visualization.</p>
</div>
<div class="section" id="grafana">
<h3><a class="toc-backref" href="#contents">Grafana</a><a class="headerlink" href="#grafana" title="Permalink to this headline"> </a></h3>
<p>This is the last file we discuss, before finally monitoring our environment
and it&#8217;s a very simple one:</p>
<div class="highlight-ini"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Full docs at http://docs.grafana.org/installation/configuration/</span>
<span class="c1"># We only keep the changes from the defaults here.</span>

<span class="c1">#################################### Anonymous Auth ##########################</span>
<span class="k">[auth.anonymous]</span>
<span class="na">enabled</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">org_role</span> <span class="o">=</span> <span class="s">Viewer</span>
</pre></div>
</td></tr></table></div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">One of the (not shown here and thereby default) values I use is the
admin password. Take care of that when you use <em>Grafana</em> in a sensitive
environment (see <a class="footnote-reference" href="#grafdoc" id="id6">[6]</a> for the full configuration).</p>
</div>
<p>The only thing I change from the defaults is, that I&#8217;d like to have reading
access for people not logged into <em>Grafana</em>. You still need to be logged in
to create, change or delete dashboards.</p>
<p>That&#8217;s the last part of the automation we use. Let&#8217;s check what we can do
with that.</p>
</div>
</div>
<div class="section" id="monitor-the-metrics">
<span id="monitoring-metrics"></span><h2><a class="toc-backref" href="#contents">Monitor the metrics</a><a class="headerlink" href="#monitor-the-metrics" title="Permalink to this headline"> </a></h2>
<p>After the playbook is executed, open the prometheus server UI at
<a class="reference external" href="http://192.168.100.10:9090/status">http://192.168.100.10:9090/status</a>. You should see that all the expected
targets are listed and in state <code class="docutils literal"><span class="pre">UP</span></code> like in this image:</p>
<a class="reference external image-reference" href="/_images/prometheus-targets-status.png"><img alt="Prometheus status page with the expected outcome." src="../../../../../_images/prometheus-targets-status.png" /></a>
<p>At <a class="reference external" href="http://192.168.100.10:9090/graph">http://192.168.100.10:9090/graph</a> you can start using the Prometheus
query language <a class="footnote-reference" href="#promq" id="id7">[7]</a> to create graphs based on the metrics the
Prometheus server scrapes from the targets in an interval. For example,
you can query the available disk space from the nodes by using
<code class="docutils literal"><span class="pre">node_filesystem_free{mountpoint='/',</span> <span class="pre">name!=''}</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">node_filesystem_free</span></code>: This is the metric you&#8217;re interested in</li>
<li><code class="docutils literal"><span class="pre">{}</span></code>: Constraints get defined in curly brackets</li>
<li><code class="docutils literal"><span class="pre">mountpoint='/'</span></code>: A constraint: only show metrics of the root directory</li>
<li><code class="docutils literal"><span class="pre">name!=''</span></code>: A constraint: only show metrics with a value for label <code class="docutils literal"><span class="pre">name</span></code></li>
</ul>
<p>The constraints get logically <code class="docutils literal"><span class="pre">AND</span></code>&#8216;ed. After setting that query in the web
UI, you should see this:</p>
<a class="reference external image-reference" href="/_images/prometheus-graph.png"><img alt="Prometheus graph page with a query for free disk space" src="../../../../../_images/prometheus-graph.png" /></a>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The (old) version of <em>Prometheus</em> I used here adds itself
automatically (not sure if this is a bug or a feature) additionally
to the setting I did (with labels), so I ignore that entry with
the constraint <code class="docutils literal"><span class="pre">name!=''</span></code> like you see in the image.</p>
</div>
<p>You&#8217;ll notice very quickly that this gets ugly. For example, the metric
is in bytes, and you cannot transform it to a human readable unit. Let&#8217;s
use <em>Grafana</em> to visualize that in a sensible way.</p>
<p>The Ansible playbook also installed and configured the <em>Grafana</em> service,
which is accessible at <a class="reference external" href="http://192.168.100.10:3000/">http://192.168.100.10:3000/</a>.</p>
<p>Sign in with username <code class="docutils literal"><span class="pre">admin</span></code> and password <code class="docutils literal"><span class="pre">admin</span></code>, select the dashboard
<em>&#8220;Infra Node Metrics&#8221;</em> and you&#8217;ll see this:</p>
<a class="reference external image-reference" href="/_images/grafana-dashboard.png"><img alt="|graf| dashboard visualizing Prometheus Node Exporter metrics" src="../../../../../_images/grafana-dashboard.png" /></a>
<p>This is the dashboard created from the file <code class="docutils literal"><span class="pre">infra-node-metrics.json</span></code>.
As said earlier, I usually use the edit functionality in the web UI to
create and change the dashboards and then export it as JSON file.</p>
<p>You can watch that for a while if you want to, but there won&#8217;t be a lot
of action. We have to trigger something which consumes the resources
we monitor. That&#8217;s where the application files we copied onto the
application servers come into play.
These files (<code class="docutils literal"><span class="pre">eat_cpu.py</span></code>, <code class="docutils literal"><span class="pre">eat_memory.py</span></code> and
<code class="docutils literal"><span class="pre">eat_disk.py</span></code>) are listed fully in <a class="reference internal" href="#appendix"><span class="std std-ref">Appendix</span></a>, I won&#8217;t describe
them in detail in this post.</p>
<p>Fire up one of the applications (inside one or both of the application
servers) to consume some resources:</p>
<div class="highlight-bash"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">[</span>markus@home<span class="o">]</span> $ vagrant ssh app-server-1
<span class="o">[</span>...<span class="o">]</span>
vagrant@app-server-1:~$ sudo su -
root@app-server-1:~#
root@app-server-1:~#
root@app-server-1:~# python eat_cpu.py <span class="p">&amp;</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span> <span class="m">2392</span>
root@app-server-1:~# <span class="nb">kill</span> -9 <span class="m">2392</span>  <span class="c1"># if you&#39;re impatient :)</span>
</pre></div>
</td></tr></table></div>
<p>You&#8217;ll see the impact immediately in your dashboard:</p>
<a class="reference external image-reference" href="/_images/grafana-cpu-consumption.png"><img alt="|graf| displays the CPU consumption" src="../../../../../_images/grafana-cpu-consumption.png" /></a>
<p>That&#8217;s it. It&#8217;s a good way to start like this and let the pattern recognition
machine in your head do its magic for some time, and learn what&#8217;s <em>&#8220;normal&#8221;</em>
and what&#8217;s an <em>&#8220;anomaly&#8221;</em>, before considering to introduce <em>alerting</em>,
another corner stone of monitoring. I won&#8217;t cover alerting in this post,
but be aware that this most probably will become necessary, as you don&#8217;t
want to watch this the whole day. Visualizing data (like resource consumption
here), is also a very good show case within your company, especially when you
try to convince people who have only 1 minute (or less) on their hand for
listening to you.</p>
<p><strong>&#8220;Homework&#8221;</strong>:</p>
<p>With this environment at your hand, you can try yourself at the following
tasks:</p>
<ul class="simple">
<li>destroy and create the environment 5 times in a row</li>
<li>run the playbook at least 3 times</li>
<li>run another one of the demo application files and watch the impact</li>
<li>visualize a query which only shows the servers labeled with <code class="docutils literal"><span class="pre">arch:</span> <span class="pre">x86</span></code></li>
<li>visualize a query which watches only the used swap in the servers</li>
<li>visualize only the CPU steal time of the monitoring server</li>
<li>add any other metric offered by the <em>Prometheus</em> node exporter to the dashboard</li>
<li>&lt;whatever-comes-to-your-mind&gt;</li>
</ul>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#contents">Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline"> </a></h2>
<p>This post showed how to monitor operating system metrics with
<em>Grafana</em>, <em>Prometheus</em> and <em>Prometheus Node Exporter</em>. The deployment
of the software happened with <em>Ansible</em>, after the server provisioning
was done with <em>Vagrant</em> and <em>VirtualBox</em>. We deployed the necessary
software by using the packaged versions from <em>Ubuntu</em>. Unfortunately,
it got decided that <em>Grafana</em> won&#8217;t be in release <em>17.10</em> and newer <a class="footnote-reference" href="#grafdrop" id="id8">[8]</a>.
This is a good chance to show in another post, how we can create
<em>Ansible Roles</em> to encapsulate the logic of getting the newest <em>Grafana</em>
source code, building it, and deploying it. This also enables us to
to make use of the much nicer API <a class="footnote-reference" href="#grafds" id="id9">[9]</a> and UI.</p>
<p>Those node metrics aren&#8217;t the only metrics you can collect. There is a
variety of different exporters <a class="footnote-reference" href="#promex" id="id10">[3]</a> which help you to keep the overview.
You can also instrument your own application to emit metrics. That&#8217;s something
I will show in another post.</p>
</div>
<div class="section" id="references">
<h2><a class="toc-backref" href="#contents">References</a><a class="headerlink" href="#references" title="Permalink to this headline"> </a></h2>
<table class="docutils footnote" frame="void" id="ansivault" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://docs.ansible.com/ansible/latest/playbooks_vault.html">http://docs.ansible.com/ansible/latest/playbooks_vault.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ansmods" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://docs.ansible.com/ansible/latest/list_of_all_modules.html">http://docs.ansible.com/ansible/latest/list_of_all_modules.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="promex" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td><em>(<a class="fn-backref" href="#id3">1</a>, <a class="fn-backref" href="#id10">2</a>)</em> <a class="reference external" href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ansiroles" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td><a class="reference external" href="http://docs.ansible.com/ansible/latest/playbooks_reuse_roles.html">http://docs.ansible.com/ansible/latest/playbooks_reuse_roles.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="promstatic" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td><a class="reference external" href="https://github.com/prometheus/prometheus/issues/1706">https://github.com/prometheus/prometheus/issues/1706</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="grafdoc" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td><a class="reference external" href="http://docs.grafana.org/installation/configuration/">http://docs.grafana.org/installation/configuration/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="promq" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td><a class="reference external" href="https://prometheus.io/docs/querying/basics/">https://prometheus.io/docs/querying/basics/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="grafdrop" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[8]</a></td><td><a class="reference external" href="https://answers.launchpad.net/ubuntu/+source/grafana/+question/658771">https://answers.launchpad.net/ubuntu/+source/grafana/+question/658771</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="grafds" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[9]</a></td><td><a class="reference external" href="http://docs.grafana.org/http_api/data_source/">http://docs.grafana.org/http_api/data_source/</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="appendix">
<span id="id11"></span><h2><a class="toc-backref" href="#contents">Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline"> </a></h2>
<p>The application code we use to impact the resource consumption of our
infrastructure is shown below. It&#8217;s basically nonsense and only for
demo purposes, that&#8217;s why I don&#8217;t add an explanation to them.</p>
<p><code class="docutils literal"><span class="pre">eat_cpu.py</span></code>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

<span class="c1"># based on https://technobeans.com/2012/04/16/5-ways-of-fibonacci-in-python/</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">50</span>

<span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">fibonacci</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p><code class="docutils literal"><span class="pre">eat_memory.py</span></code>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

<span class="c1"># based on https://stackoverflow.com/questions/6317818/how-to-eat-memory-using-python</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="n">blanks</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">blanks</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">50</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">MemoryError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;We&#39;re going out of memory.&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p><code class="docutils literal"><span class="pre">eat_disk.py</span></code>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">call</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;dd if=/dev/zero of=big-file-</span><span class="si">%s</span><span class="s2"> count=1024 bs=1048576&quot;</span> <span class="o">%</span> <span class="n">i</span>
    <span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># https://stackoverflow.com/questions/8816059/create-file-of-particular-size-in-python</span>
<span class="c1"># creates files of 1GB size but `df -h` doesn&#39;t recognize that (not sure why).</span>
</pre></div>
</td></tr></table></div>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  Previous: 
  <a href="../../13/book-phoenix-project/">
    
    Recommendation: The Phoenix Project
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  Next: 
  <a href="../../../11/10/osse-prague-2017/">
    The 2017 Open Source Summit Europe in Praque
    
  </a>
  </span>
  
</div>

  
  
  </div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015-2022, Markus Zoeller.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>