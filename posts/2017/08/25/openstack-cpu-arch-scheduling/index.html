<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>OpenStack Nova Scheduling based on CPU architecture &#8212; Markus Zoeller Blog</title>
    
    <link rel="stylesheet" href="../../../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../../about/" />
    <link rel="index" title="Index" href="../../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../../search/" />
  
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  
  <link rel="alternate" type="application/atom+xml"  href="../../../../../posts/atom.xml" title="Markus's Brain Swap Space">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../../">
          MZIO</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../../../about/">About</a></li>
                <li><a href="../../../../category/">Categories</a></li>
                <li><a href="../../../../tag/">Tags</a></li>
                <li><a href="../../../../archive/">Archives</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../../">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../../search/" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="openstack-nova-scheduling-based-on-cpu-architecture">
<h1>OpenStack Nova Scheduling based on CPU architecture<a class="headerlink" href="#openstack-nova-scheduling-based-on-cpu-architecture" title="Permalink to this headline"> </a></h1>
<p>If you have an OpenStack cloud with compute nodes with different CPU
architectures, then this post will give you the needed information about
how to tag your guest images, which enables the Nova scheduler to find
a target with the correct CPU architecture.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#tl-dr" id="id14">TL;DR</a></li>
<li><a class="reference internal" href="#use-case" id="id15">Use Case</a></li>
<li><a class="reference internal" href="#guest-image-metadata-properties" id="id16">Guest image metadata properties</a></li>
<li><a class="reference internal" href="#impact-to-the-nova-scheduler" id="id17">Impact to the Nova scheduler</a></li>
<li><a class="reference internal" href="#references" id="id18">References</a></li>
</ul>
</div>
<table border="1" class="docutils" id="id13">
<caption><span class="caption-text">Change history:</span><a class="headerlink" href="#id13" title="Permalink to this table"> </a></caption>
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Date</th>
<th class="head">Change description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>2017-08-25</td>
<td>The first release</td>
</tr>
</tbody>
</table>
<div class="section" id="tl-dr">
<h2><a class="toc-backref" href="#contents">TL;DR</a><a class="headerlink" href="#tl-dr" title="Permalink to this headline"> </a></h2>
<p>Use <code class="docutils literal"><span class="pre">hw_architecture</span></code> instead of <code class="docutils literal"><span class="pre">architecture</span></code> or <code class="docutils literal"><span class="pre">cpu_arch</span></code>.</p>
<ul>
<li><p class="first">OpenStack CLI:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ openstack image set &lt;IMG-UUID&gt; --property hw_architecture=s390x
</pre></div>
</div>
</li>
<li><p class="first"><em>Ansible</em> module <em>os_image</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Upload bootable s390x guest image into Glance.&quot;</span>
  <span class="n">os_image</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">ubuntu_z</span>
    <span class="n">filename</span><span class="p">:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ubuntu_s390x_disk</span><span class="o">.</span><span class="n">img</span>
    <span class="n">container_format</span><span class="p">:</span> <span class="n">bare</span>
    <span class="n">disk_format</span><span class="p">:</span> <span class="n">raw</span>
    <span class="n">properties</span><span class="p">:</span>
      <span class="n">hw_architecture</span><span class="p">:</span> <span class="n">s390x</span>
</pre></div>
</div>
</li>
</ul>
<p>If that TL;DR doesn&#8217;t make sense to you, you&#8217;ll find a more exhaustive
version below.</p>
</div>
<div class="section" id="use-case">
<h2><a class="toc-backref" href="#contents">Use Case</a><a class="headerlink" href="#use-case" title="Permalink to this headline"> </a></h2>
<p>Let&#8217;s assume you have set up an OpenStack cloud with compute nodes
of different CPU architectures. For example, some Intel x86 compute nodes,
some IBM Z s390x compute nodes (and maybe some IBM POWER ppc64 compute
nodes).</p>
<a class="reference external image-reference" href="/_images/multi-arch-cmp-nodes.svg"><img alt="An OpenStack cloud with compute nodes of different CPU architectures." src="../../../../../_images/multi-arch-cmp-nodes.svg" /></a>
<p>Those compute hosts with different CPU architectures need guest images which
were built for those architectures. All an OpenStack user sees are the
different guest images prepare by an OpenStack admin/operator.
For the sake of example, maybe something like this:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ openstack image list
+--------------------------------------+----------+--------+
| ID                                   | Name     | Status |
+--------------------------------------+----------+--------+
| 7045d1c5-a927-4d49-9fe2-d3f63075591f | ubuntu_x | active |
| c5f206d1-d288-47fe-a67f-29a8b464bfc7 | ubuntu_p | active |
| 54c25961-d1ff-4d28-ac1a-41293ab9132b | ubuntu_z | active |
| ce7bea92-1e1d-4062-99bc-01a1db1a4b45 | rhel_x   | active |
| 46ecff6d-dd7f-4907-b7b3-57d0d7290e03 | rhel_z   | active |
| 4ef7df70-c5b8-43b9-9812-dfd4cd3e3c09 | suse_p   | active |
| ff208726-1ae5-4b40-84d4-571e06aff8e5 | suse_z   | active |
+--------------------------------------+----------+--------+
</pre></div>
</td></tr></table></div>
<p>The openstack users usually don&#8217;t see the details of the different compute
nodes. They don&#8217;t need to and shouldn&#8217;t. All they want is that this
architecture specific image gets scheduled on the compute node which can
fulfill their needs.</p>
</div>
<div class="section" id="guest-image-metadata-properties">
<h2><a class="toc-backref" href="#contents">Guest image metadata properties</a><a class="headerlink" href="#guest-image-metadata-properties" title="Permalink to this headline"> </a></h2>
<p>The most reasonable way I know to do this, is to add <em>Glance</em> image metadata,
which specifies the CPU architecture of that image so that other OpenStack
services can use that information. The one OpenStack service we need for that,
is the <em>Nova</em> scheduler service. Specifically one of its filters, the
<code class="docutils literal"><span class="pre">ImagePropertiesFilter</span></code>.</p>
<p>Unfortunately, the docs in Glance don&#8217;t make it <strong>that</strong> obvious which
value you have to set. You will most likely stumble upon the metadata
property <code class="docutils literal"><span class="pre">architecture</span></code>. The Glance docs <a class="footnote-reference" href="#id7" id="id1">[1]</a> say this:</p>
<blockquote>
<div><em>&#8220;The CPU architecture that must be supported by the hypervisor.</em>
<em>For example, x86_64, arm, or ppc64.&#8221;</em></div></blockquote>
<p>Sounds like the correct one for your use-case, right? The openstack CLI
also says to use this <a class="footnote-reference" href="#id8" id="id2">[2]</a>.</p>
<p>It gets a bit more confusing when you want to use the <em>Ansible</em> module
<em>os_image</em> <a class="footnote-reference" href="#id9" id="id3">[3]</a> for your <em>Infrastructure as Code (IaC)</em>. The example there
uses <code class="docutils literal"><span class="pre">cpu_arch</span></code>:</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">os_image</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cirros</span>
    <span class="l l-Scalar l-Scalar-Plain">container_format</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bare</span>
    <span class="l l-Scalar l-Scalar-Plain">disk_format</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">qcow2</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="l l-Scalar l-Scalar-Plain">filename</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cirros-0.3.0-x86_64-disk.img</span>
    <span class="l l-Scalar l-Scalar-Plain">properties</span><span class="p p-Indicator">:</span>
<span class="hll">      <span class="l l-Scalar l-Scalar-Plain">cpu_arch</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">x86_64</span>
</span>      <span class="l l-Scalar l-Scalar-Plain">distro</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
</pre></div>
</td></tr></table></div>
<p>I&#8217;m not sure if that metadata property has any effect anywhere. It hadn&#8217;t
when I tested the Nova scheduling with it. A discussion on the OpenStack
mailing list tried to find actions how to resolve this <a class="footnote-reference" href="#id10" id="id4">[4]</a>.</p>
</div>
<div class="section" id="impact-to-the-nova-scheduler">
<h2><a class="toc-backref" href="#contents">Impact to the Nova scheduler</a><a class="headerlink" href="#impact-to-the-nova-scheduler" title="Permalink to this headline"> </a></h2>
<p>Long story short, I don&#8217;t know the history of how it happened, but the <em>Nova</em>
scheduler filter <code class="docutils literal"><span class="pre">ImagePropertiesFilter</span></code> which we want to use, needs the
property to be named <code class="docutils literal"><span class="pre">hw_architecture</span></code> <a class="footnote-reference" href="#id11" id="id5">[5]</a>.</p>
<p>Apply the metadata property with:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ openstack image set &lt;IMG-UUID&gt; --property hw_architecture=s390x
</pre></div>
</div>
<p>Double-check the property with:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ openstack image show &lt;IMG-UUID&gt;
+------------------+------------------------------------------------------+
| Field            | Value                                                |
+------------------+------------------------------------------------------+
| ...              | ...                                                  |
| container_format | bare                                                 |
| disk_format      | raw                                                  |
| id               | &lt;IMG-UUID&gt;                                           |
| min_disk         | 0                                                    |
| min_ram          | 0                                                    |
| name             | ubuntu_z                                             |
<span class="hll">| properties       | hw_architecture=&#39;s390x&#39;                              |
</span>| schema           | /v2/schemas/image                                    |
| status           | active                                               |
+------------------+------------------------------------------------------+
</pre></div>
</td></tr></table></div>
<p>When this is applied to the image, and a user launches that image,
the <em>Nova</em> scheduler filters out hosts which don&#8217;t offer that CPU architecture.
You can see the filtering happening in the <em>Nova</em> scheduler logs. The
shortened example below starts with 2 compute nodes, one with <code class="docutils literal"><span class="pre">x86</span></code>
and the other one with <code class="docutils literal"><span class="pre">s390x</span></code>:</p>
<div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$ grep filter /var/log/nova/nova-scheduler.log
<span class="hll">DEBUG nova.filters [...] Starting with 2 host(s)
</span>DEBUG nova.scheduler.filters.retry_filter [...] Re-scheduling is disabled host_passes
DEBUG nova.scheduler.filters.retry_filter [...] Re-scheduling is disabled host_passes
DEBUG nova.filters [...] Filter RetryFilter returned 2 host(s)
DEBUG nova.filters [...] Filter AvailabilityZoneFilter
DEBUG nova.filters [...] Filter RamFilter returned 2 host(s)
DEBUG nova.filters [...] Filter ComputeFilter returned 2 host(s)
DEBUG nova.filters [...] Filter ComputeCapabilitiesFilter returned 2 host(s)
DEBUG nova.scheduler.filters.image_props_filter [...]
<span class="hll">    Instance contains properties ImageMetaProps(hw_architecture=&#39;s390x&#39;,...)
</span><span class="hll">    that are not provided by the compute node
</span>DEBUG nova.scheduler.filters.image_props_filter [...] (cmpx1, cmpx1)
    ram: 142990MB disk: 91136MB io_ops: 0 instances: 0
    does not support requested instance_properties
<span class="hll">DEBUG nova.filters [...] Filter ImagePropertiesFilter returned 1 host(s)
</span></pre></div>
</td></tr></table></div>
<p>You&#8217;ll notice that the <code class="docutils literal"><span class="pre">ImagePropertiesFilter</span></code> removed the one compute
node which cannot fulfill the <code class="docutils literal"><span class="pre">ImageMetaProps</span></code>. We started with 2 hosts
and at the end only one host is an eligible target host for the Instance,
because it offers the prerequisite defined with <code class="docutils literal"><span class="pre">hw_architecture</span></code>. A
full list of supported CPU architectures can be found at <a class="footnote-reference" href="#id12" id="id6">[6]</a>.</p>
</div>
<div class="section" id="references">
<h2><a class="toc-backref" href="#contents">References</a><a class="headerlink" href="#references" title="Permalink to this headline"> </a></h2>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html">https://docs.openstack.org/python-glanceclient/latest/cli/property-keys.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="https://docs.openstack.org/python-openstackclient/latest/cli/command-objects/image.html#image-set">https://docs.openstack.org/python-openstackclient/latest/cli/command-objects/image.html#image-set</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="http://docs.ansible.com/ansible/latest/os_image_module.html">http://docs.ansible.com/ansible/latest/os_image_module.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td><a class="reference external" href="http://lists.openstack.org/pipermail/openstack-dev/2017-August/121371.html">http://lists.openstack.org/pipermail/openstack-dev/2017-August/121371.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td><a class="reference external" href="https://github.com/openstack/nova/blob/4a7502a5c9e84a8c8cef7f355d72425b26b8c379/nova/scheduler/filters/image_props_filter.py#L44">https://github.com/openstack/nova/blob/4a7502a5c9e84a8c8cef7f355d72425b26b8c379/nova/scheduler/filters/image_props_filter.py#L44</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td><a class="reference external" href="https://github.com/openstack/nova/blob/4a7502a5c9e84a8c8cef7f355d72425b26b8c379/nova/objects/fields.py#L92">https://github.com/openstack/nova/blob/4a7502a5c9e84a8c8cef7f355d72425b26b8c379/nova/objects/fields.py#L92</a></td></tr>
</tbody>
</table>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  Previous: 
  <a href="../../../../2016/03/06/grafana-graphite-statsd/">
    
    Setup Grafana + Graphite + Statsd
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  Next: 
  <a href="../../../09/29/logrotate/">
    Basics about Logrotate
    
  </a>
  </span>
  
</div>

  
  
    <div class="section">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'mzio';
        var disqus_identifier = '/posts/2017/08/25/openstack-cpu-arch-scheduling/';
        var disqus_title = 'OpenStack Nova Scheduling based on CPU architecture';
        var disqus_url = 'http://www.markusz.io/posts/2017/08/25/openstack-cpu-arch-scheduling/';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  
  </div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015-2017, Markus Zoeller.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>