<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Setup Grafana + Graphite + Statsd &#8212; Markus Zoeller Blog</title>
    
    <link rel="stylesheet" href="../../../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../../about/" />
    <link rel="index" title="Index" href="../../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../../search/" />
  
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  
  <link rel="alternate" type="application/atom+xml"  href="../../../../../posts/atom.xml" title="Markus's Brain Swap Space">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../../">
          MZIO</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../../../about/">About</a></li>
                <li><a href="../../../../category/">Categories</a></li>
                <li><a href="../../../../tag/">Tags</a></li>
                <li><a href="../../../../archive/">Archives</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../../">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Setup Grafana + Graphite + Statsd</a><ul>
<li><a class="reference internal" href="#environment">Environment</a></li>
<li><a class="reference internal" href="#step-by-step">Step-by-Step</a><ul>
<li><a class="reference internal" href="#a-few-prerequisites">A few Prerequisites</a></li>
<li><a class="reference internal" href="#setup-statsd-and-graphite">Setup Statsd and Graphite</a></li>
<li><a class="reference internal" href="#setup-grafana">Setup Grafana</a></li>
<li><a class="reference internal" href="#collect-and-push-custom-metrics">Collect and Push Custom Metrics</a></li>
<li><a class="reference internal" href="#build-a-templated-graph-in-grafana">Build a Templated Graph in Grafana</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../../search/" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="setup-grafana-graphite-statsd">
<h1>Setup Grafana + Graphite + Statsd<a class="headerlink" href="#setup-grafana-graphite-statsd" title="Permalink to this headline"> </a></h1>
<p>If you ever played around with time series data and wanted to visualize them
with graphs in a nice way you probably have heard about <em>Grafana</em>. This
post provides a step-by-step instruction on how to build a <em>Grafana</em>-playground
in about 15 minutes. The setup will be build of <em>statsd</em> to collect metrics,
<em>graphite</em> to store those metrics, and <em>Grafana</em> to visualize those metrics.
We will also create and push custom metrics and create templated graphs based
on them. This post won&#8217;t provide any in-depth details about <em>statsd</em>,
<em>graphite</em> and <em>Grafana</em> itself.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#environment" id="id10">Environment</a></li>
<li><a class="reference internal" href="#step-by-step" id="id11">Step-by-Step</a><ul>
<li><a class="reference internal" href="#a-few-prerequisites" id="id12">A few Prerequisites</a></li>
<li><a class="reference internal" href="#setup-statsd-and-graphite" id="id13">Setup Statsd and Graphite</a></li>
<li><a class="reference internal" href="#setup-grafana" id="id14">Setup Grafana</a></li>
<li><a class="reference internal" href="#collect-and-push-custom-metrics" id="id15">Collect and Push Custom Metrics</a></li>
<li><a class="reference internal" href="#build-a-templated-graph-in-grafana" id="id16">Build a Templated Graph in Grafana</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion" id="id17">Conclusion</a></li>
<li><a class="reference internal" href="#references" id="id18">References</a></li>
</ul>
</div>
<p>Change history:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Date</th>
<th class="head">Change description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>2016-03-06</td>
<td>The first release</td>
</tr>
<tr class="row-odd"><td>2016-03-08</td>
<td>Changed the wording about the directories in <code class="docutils literal"><span class="pre">/opt/</span></code> and fixed
a few minor grammar issues.</td>
</tr>
</tbody>
</table>
<div class="section" id="environment">
<h2><a class="toc-backref" href="#contents">Environment</a><a class="headerlink" href="#environment" title="Permalink to this headline"> </a></h2>
<p>The environment I used to write this post consists of:</p>
<ul class="simple">
<li>a virtual machine hosted by <em>DigitalOcean</em></li>
<li>Ubuntu 14.04 as VM host OS</li>
<li>python2.7 as runtime for the script to create custom metrics</li>
</ul>
<p>Please note that:</p>
<ul class="simple">
<li>this setup is only useful in proof of concepts and shouldn&#8217;t be used in
a productive environment</li>
<li>The helper script <em>synthesize</em> we will use claims to only run on Ubuntu 14.04</li>
<li>The python version 2.7 is caused by the library <em>launchpadlib</em> we will use
later to create the custom metrics</li>
</ul>
</div>
<div class="section" id="step-by-step">
<h2><a class="toc-backref" href="#contents">Step-by-Step</a><a class="headerlink" href="#step-by-step" title="Permalink to this headline"> </a></h2>
<div class="section" id="a-few-prerequisites">
<span id="prereqs"></span><h3><a class="toc-backref" href="#contents">A few Prerequisites</a><a class="headerlink" href="#a-few-prerequisites" title="Permalink to this headline"> </a></h3>
<p>Change the time zone of the VM to <code class="docutils literal"><span class="pre">UTC-0</span></code>, otherwise the time series data will
be bound to the time zone the VM got created with. This time zone could be
different each time you build a VM in a public cloud, depending on the cloud
provider and the location of the data centers they use.
After executing the command below, select <code class="docutils literal"><span class="pre">Europe</span> <span class="pre">-&gt;</span> <span class="pre">London</span></code> to do that.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ dpkg-reconfigure tzdata
</pre></div>
</div>
<p>We will later use helper scripts from a <em>github</em> repo, so we need <em>git</em> to
clone these scripts:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ apt-get install -y git
</pre></div>
</div>
<p>Create the directories which will contain our artifacts to get things running.
I&#8217;ve chosen those arbitrarily, there is no technical need to use these but
I will use them throughout this post:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ mkdir -p /opt/grafana-poc/statsd-graphite/
$ mkdir -p /opt/grafana-poc/grafana-bin/
$ mkdir -p /opt/grafana-poc/custom-stats/
</pre></div>
</div>
<p>For the custom time series data we will create in a later step we will need
additional python packages:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ pip install launchpadlib
$ pip install python-statsd
</pre></div>
</div>
</div>
<div class="section" id="setup-statsd-and-graphite">
<span id="synthesize"></span><h3><a class="toc-backref" href="#contents">Setup Statsd and Graphite</a><a class="headerlink" href="#setup-statsd-and-graphite" title="Permalink to this headline"> </a></h3>
<p><em>Synthesize</em> <a class="footnote-reference" href="#id6" id="id1">[1]</a> installs <em>statsd</em> and <em>graphite</em> for us:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /opt/grafana-poc/statsd-graphite/
$ git clone https://github.com/obfuscurity/synthesize
$ <span class="nb">cd</span> synthesize
$ ./install
</pre></div>
</div>
<p>You can access the web UI of <em>graphite</em> at port <code class="docutils literal"><span class="pre">80</span></code>. There are already
some metrics about the host machine (CPU time, memory usage, ...) in there.
You will see that the metrics are structured in a hierarchy. That will be
interesting later when we create a query in <em>Grafana</em>.</p>
<p>The default credentials to log in are:</p>
<ul class="simple">
<li>username: <code class="docutils literal"><span class="pre">admin</span></code></li>
<li>password: <code class="docutils literal"><span class="pre">graphite_me_synthesize</span></code></li>
</ul>
</div>
<div class="section" id="setup-grafana">
<span id="id2"></span><h3><a class="toc-backref" href="#contents">Setup Grafana</a><a class="headerlink" href="#setup-grafana" title="Permalink to this headline"> </a></h3>
<p>As <em>Grafana</em> is not in the official repos of Ubuntu 14.04 we will download
the package and install like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /opt/grafana-poc/grafana-bin/
$ wget https://grafanarel.s3.amazonaws.com/builds/grafana_2.6.0_amd64.deb
$ apt-get install -y adduser libfontconfig
$ dpkg -i grafana_2.6.0_amd64.deb
</pre></div>
</div>
<p>Other installation methods are described in <a class="footnote-reference" href="#id7" id="id3">[2]</a>.</p>
<p>You may want to allow anonymous access with <em>viewer</em> rights <a class="footnote-reference" href="#id8" id="id4">[3]</a>. Be aware
that users which are <em>not</em> logged in (and therefore are in the <em>viewer</em> role)
can create dashboards but cannot save them.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ vim /etc/grafana/grafana.ini
</pre></div>
</div>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[auth.anonymous]</span>
<span class="na">enabled</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">org_role</span> <span class="o">=</span> <span class="s">viewer</span>
</pre></div>
</div>
<p>Everything is set up, start the engines:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ service grafana-server start
</pre></div>
</div>
<p>Open the grafana dashboard with your browser and use port <code class="docutils literal"><span class="pre">3000</span></code> in the URL.
This is the admin URL which is necessary to save your created dashboards.</p>
<p>The default credentials to log in are:</p>
<ul class="simple">
<li>username: <code class="docutils literal"><span class="pre">admin</span></code></li>
<li>password: <code class="docutils literal"><span class="pre">admin</span></code></li>
</ul>
<p>The Grafana UI is intuitive and you can build dashboards with graphs easily.
We will create one after we pushed some custom metrics to <em>statsd</em>.</p>
</div>
<div class="section" id="collect-and-push-custom-metrics">
<span id="custom-metrics"></span><h3><a class="toc-backref" href="#contents">Collect and Push Custom Metrics</a><a class="headerlink" href="#collect-and-push-custom-metrics" title="Permalink to this headline"> </a></h3>
<p>If you want to push your own metrics, below is an example.
It queries information about <em>OpenStack Nova</em> bug reports from <em>Launchpad</em> and
pushes it to <em>statsd</em>. It&#8217;s a simplified version of a PoC I made
which I intend to make part of <a class="footnote-reference" href="#id9" id="id5">[4]</a>. The key parts of the code are highlighted.</p>
<p>Go to the directory where we  will create script:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /opt/grafana-poc/custom-stats/
</pre></div>
</div>
<p>Create the file <code class="docutils literal"><span class="pre">bug_stats.py</span></code> which collects the metrics and pushes them
to <em>statsd</em>. The highlighted lines are the key points and will be explained
after the script:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ vim bug_stats.py
</pre></div>
</div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">launchpadlib.launchpad</span> <span class="kn">import</span> <span class="n">Launchpad</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="hll"><span class="kn">import</span> <span class="nn">statsd</span>
</span>

<span class="k">class</span> <span class="nc">BugStatsCollector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Collect bug stats by Launchpad project name &quot;&quot;&quot;</span>

    <span class="n">LP_OPEN_STATUSES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;New&quot;</span><span class="p">,</span> <span class="s2">&quot;Incomplete&quot;</span><span class="p">,</span> <span class="s2">&quot;Confirmed&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Triaged&quot;</span><span class="p">,</span> <span class="s2">&quot;In Progress&quot;</span><span class="p">]</span>

    <span class="n">LP_IMPORTANCES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Undecided&quot;</span><span class="p">,</span> <span class="s2">&quot;Wishlist&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;Medium&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Critical&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>

        <span class="n">cachedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.launchpadlib/cache/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cachedir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="mi">0</span><span class="n">o700</span><span class="p">)</span>
        <span class="n">launchpad</span> <span class="o">=</span> <span class="n">Launchpad</span><span class="o">.</span><span class="n">login_anonymously</span><span class="p">(</span><span class="s1">&#39;bugstats&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;production&#39;</span><span class="p">,</span>
                                                <span class="n">cachedir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">launchpad</span><span class="o">.</span><span class="n">projects</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_open_by_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the stats for open bugs, separated by importance.</span>

<span class="sd">        :rtype: list of 2-tuple key-value pairs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">importance_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">importance</span> <span class="ow">in</span> <span class="n">BugStatsCollector</span><span class="o">.</span><span class="n">LP_IMPORTANCES</span><span class="p">:</span>
            <span class="n">bug_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">searchTasks</span><span class="p">(</span>
                <span class="n">status</span><span class="o">=</span><span class="n">BugStatsCollector</span><span class="o">.</span><span class="n">LP_OPEN_STATUSES</span><span class="p">,</span>
                <span class="n">importance</span><span class="o">=</span><span class="n">importance</span><span class="p">,</span>
                <span class="n">omit_duplicates</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">stats_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_valid_stat_key_name</span><span class="p">(</span><span class="n">importance</span><span class="p">)</span>
            <span class="n">stats_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_bug_tasks</span><span class="p">(</span><span class="n">bug_tasks</span><span class="p">)</span>
<span class="hll">            <span class="n">stat</span> <span class="o">=</span><span class="p">(</span><span class="n">stats_key</span><span class="p">,</span> <span class="n">stats_value</span><span class="p">)</span>
</span>            <span class="n">importance_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">importance_stats</span>

    <span class="k">def</span> <span class="nf">_get_valid_stat_key_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">stat_key</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">stat_key</span> <span class="o">=</span> <span class="n">stat_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">stat_key</span> <span class="o">=</span> <span class="n">stat_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">stat_key</span> <span class="o">=</span> <span class="n">stat_key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stat_key</span>

    <span class="k">def</span> <span class="nf">_count_bug_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bug_tasks</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">bug_tasks</span><span class="o">.</span><span class="n">_wadl_resource</span><span class="o">.</span><span class="n">representation</span><span class="p">[</span><span class="s1">&#39;total_size&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">push_to_statsd</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">bug_stats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;push bug statistics to statsd on this host machine</span>

<span class="sd">    :param metric_name: The name of the metric</span>
<span class="sd">    :param bug_stats: list of 2-tuple key-value pairs to push</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;metric name: &quot;</span> <span class="o">+</span> <span class="n">metric_name</span><span class="p">)</span>
<span class="hll">    <span class="n">gauge</span> <span class="o">=</span> <span class="n">statsd</span><span class="o">.</span><span class="n">Gauge</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
</span>    <span class="k">for</span> <span class="n">bug_stat</span> <span class="ow">in</span> <span class="n">bug_stats</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bug_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bug_stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="hll">        <span class="n">gauge</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bug_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bug_stat</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">projects</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nova&#39;</span><span class="p">,</span> <span class="s1">&#39;python-novaclient&#39;</span><span class="p">,</span> <span class="s1">&#39;cinder&#39;</span><span class="p">,</span> <span class="s1">&#39;neutron&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="n">projects</span><span class="p">:</span>
        <span class="n">collector</span> <span class="o">=</span> <span class="n">BugStatsCollector</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>
<span class="hll">        <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;launchpad.bugs.</span><span class="si">%s</span><span class="s1">.open-by-importance&#39;</span> <span class="o">%</span> <span class="n">project_name</span>
</span>        <span class="n">bug_stats</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">get_open_by_importance</span><span class="p">()</span>
        <span class="n">push_to_statsd</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">bug_stats</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<ul class="simple">
<li>line 6 makes use of the python package we installed in <a class="reference internal" href="#prereqs"><span class="std std-ref">A few Prerequisites</span></a>.
We can now interact with the local <em>statsd</em> daemon on this machine.</li>
<li>line 42 creates one single metric we will later push to <em>statsd</em>.
The key is one of the possible bug report importances and the value is
the number of bug reports associated with it. For example: <code class="docutils literal"><span class="pre">high:33</span></code> means,
we have 33 bug reports which are rated with a high importance.</li>
<li>line 64 creates the object which can push a metric.</li>
<li>line 67 pushes the metric we collected in line 42 for a specific metric name.
The metric name can be seen as a category.</li>
<li>line 74 declares a metric name based on the OpenStack Launchpad project.
<em>statsd</em> will interpret the dots as hierarchy separators.</li>
</ul>
<p>This script will create this hierarchy in <em>graphite</em>:</p>
<a class="reference external image-reference" href="/_images/graphite_gauges.jpg"><img alt="The statsd gauges displayed in graphite" src="../../../../../_images/graphite_gauges.jpg" /></a>
<p>The leaves of this tree will be filled with the values we provide attached
to a timestamp <em>statsd</em> will get from the host. That&#8217;s why setting the
time zone in <a class="reference internal" href="#prereqs"><span class="std std-ref">A few Prerequisites</span></a> was important. Running this script multiple times
will create the time series data we want to visualize with <em>Grafana</em>.</p>
<p>Run <code class="docutils literal"><span class="pre">bug_stats.py</span></code> in an interval of 5 minutes (= 300 seconds) as <code class="docutils literal"><span class="pre">nohup</span></code>
to avoid interruption when the SSH session to your VM terminates:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ nohup watch -n <span class="m">300</span> python /opt/grafana-poc/custom-stats/bug_stats.py <span class="p">&amp;</span>
</pre></div>
</div>
<p>In case you want to kill that background process:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ps aux <span class="p">|</span> grep bug_stats
$ <span class="nb">kill</span> -9 &lt;pid&gt;
</pre></div>
</div>
<p>As the script above collects metric data which doesn&#8217;t change <em>that</em> much a day
we won&#8217;t see any major spikes and drastic changes, but it gives you an
idea how to do it with data you are interested in. I&#8217;ve chosen the Launchpad
data because I&#8217;m involved in the bug management in <em>OpenStack Nova</em> and have an
interest in trends and historical data of bug reports.</p>
</div>
<div class="section" id="build-a-templated-graph-in-grafana">
<h3><a class="toc-backref" href="#contents">Build a Templated Graph in Grafana</a><a class="headerlink" href="#build-a-templated-graph-in-grafana" title="Permalink to this headline"> </a></h3>
<p>As we get the stats from 4 different projects and want to reuse the same
graph, we will template it with the project name.</p>
<p>At first we need to connect Grafana to the datasource <em>graphite</em>. Use the
credentials mentioned in <a class="reference internal" href="#synthesize"><span class="std std-ref">Setup Statsd and Graphite</span></a> if you haven&#8217;t changed them.</p>
<p>The name of the datasource will be used in later steps.</p>
<a class="reference external image-reference" href="/_images/grafana_datasource.jpg"><img alt="Grafana can work with different datasources, we will use graphite" src="../../../../../_images/grafana_datasource.jpg" /></a>
<p>After that we can create a variable so that we can switch between the four
different projects. We use the datasource from the previous step and query
the project names. The name of the variable is used later in data queries.</p>
<a class="reference external image-reference" href="/_images/grafana_templating.jpg"><img alt="Templating with variables makes graphs more generic" src="../../../../../_images/grafana_templating.jpg" /></a>
<p>Now we can build a graph which makes use of the custom metrics we collected.
We will also use the variable we declared in our query to use the same graph
for different projects. You will notice that the query we use matches the
metric name we declared in <a class="reference internal" href="#custom-metrics"><span class="std std-ref">Collect and Push Custom Metrics</span></a>.</p>
<a class="reference external image-reference" href="/_images/grafana_templated_query.jpg"><img alt="A variable can be used in grafana queries." src="../../../../../_images/grafana_templated_query.jpg" /></a>
<p>Save the dashboard and switch between the projects to see the different
collected data.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#contents">Conclusion</a><a class="headerlink" href="#conclusion" title="Permalink to this headline"> </a></h2>
<p>Provided with the steps above you should get a running playground in around
15 minutes. All the pieces work together without any fakes or mocks. Playing
around with your custom time series data and its visualization with <em>Grafana</em>
for PoCs should now be easier. Grafana provides a lot of functions to
manipulate the data:</p>
<ul class="simple">
<li>percentage distribution</li>
<li>accumulation</li>
<li>rolling averages</li>
<li>...</li>
</ul>
<p>This data visualization of time series data can give you a lot of insights
into the entity you monitor.</p>
</div>
<div class="section" id="references">
<h2><a class="toc-backref" href="#contents">References</a><a class="headerlink" href="#references" title="Permalink to this headline"> </a></h2>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://github.com/obfuscurity/synthesize/">https://github.com/obfuscurity/synthesize/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td><a class="reference external" href="http://docs.grafana.org/installation/debian/">http://docs.grafana.org/installation/debian/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td><a class="reference external" href="http://docs.grafana.org/installation/configuration/">http://docs.grafana.org/installation/configuration/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[4]</a></td><td><a class="reference external" href="http://grafana.openstack.org/">http://grafana.openstack.org/</a></td></tr>
</tbody>
</table>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  Previous: 
  <a href="../../../../2015/12/01/openstack-bugs/">
    
    OpenStack's Bug Management
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  Next: 
  <a href="../../../../2017/08/25/openstack-cpu-arch-scheduling/">
    OpenStack Nova Scheduling based on CPU architecture
    
  </a>
  </span>
  
</div>

  
  
    <div class="section">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'mzio';
        var disqus_identifier = '/posts/2016/03/06/grafana-graphite-statsd/';
        var disqus_title = 'Setup Grafana + Graphite + Statsd';
        var disqus_url = 'http://markuszoeller.github.io/posts/2016/03/06/grafana-graphite-statsd';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  
  </div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015, Markus Zoeller.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>